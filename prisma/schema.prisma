generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Counter {
  id        String  @id @default(cuid())
  companyId String
  key       String
  value     Int     @default(0)
  company   Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId])
}

model FrameMeasurement {
  id             String       @id @default(cuid())
  companyId      String
  company        Company      @relation(fields: [companyId], references: [id])
  serviceOrderId String
  serviceOrder   ServiceOrder @relation(fields: [serviceOrderId], references: [id])

  // Medidas da armação
  frameWidth   Decimal? @db.Decimal(5, 1) // Largura total (mm)
  bridgeSize   Decimal? @db.Decimal(4, 1) // Ponte (mm)
  lensWidth    Decimal? @db.Decimal(4, 1) // Largura da lente (mm)
  lensHeight   Decimal? @db.Decimal(4, 1) // Altura da lente (mm)
  templeLength Decimal? @db.Decimal(4, 1) // Comprimento da haste (mm)

  // Medidas do cliente na armação
  pdRight     Decimal? @db.Decimal(4, 1) // DP OD (mm)
  pdLeft      Decimal? @db.Decimal(4, 1) // DP OE (mm)
  heightRight Decimal? @db.Decimal(4, 1) // Altura OD (mm)
  heightLeft  Decimal? @db.Decimal(4, 1) // Altura OE (mm)

  // Dados adicionais
  frameModel    String?
  frameColor    String?
  frameMaterial String? // ACETATO, METAL, TITANIO, etc.

  // Quem mediu
  measuredByUserId String?
  measuredBy       User?    @relation("FrameMeasurer", fields: [measuredByUserId], references: [id])
  measuredAt       DateTime @default(now())

  observations String?

  @@index([serviceOrderId])
  @@index([companyId])
}

model CashRegister {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])

  name        String // "Caixa 1", "PDV Principal"
  code        String // "CX01" - código curto
  description String?

  allowNegative  Boolean @default(false)
  requireBlind   Boolean @default(false)
  printerType    String? // THERMAL, LASER, NONE
  printerAddress String?

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cashShifts CashShift[]

  @@unique([companyId, code])
  @@index([branchId, active])
}

model CardFeeRule {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  brand        String // VISA, MASTERCARD, ELO, AMEX, HIPERCARD, PIX
  paymentType  String // CREDIT, DEBIT, PIX
  installments Int    @default(1)

  feePercent     Decimal @db.Decimal(5, 4)
  feeFixed       Decimal @default(0) @db.Decimal(10, 2)
  settlementDays Int

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, brand, paymentType, installments])
  @@index([companyId, active])
}

model Company {
  id                 String              @id @default(cuid())
  name               String
  tradeName          String?
  cnpj               String?             @unique
  address            String?
  city               String?
  state              String?
  zipCode            String?
  phone              String?
  email              String?
  website            String?
  logoPath           String?
  settings           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
  agreements         Agreement[]
  appointments       Appointment[]
  auditLogs          AuditLog[]
  branches           Branch[]
  brands             Brand[]
  cashShifts         CashShift[]
  categories         Category[]
  colors             Color[]
  commissions        Commission[]
  commissionRules    CommissionRule[]
  companySettings    CompanySettings?    @relation("CompanySettings")
  customers          Customer[]
  dreReports         DREReport[]
  doctors            Doctor[]
  labs               Lab[]
  lensTreatments     LensTreatment[]     @relation("CompanyLensTreatments")
  loyaltyPoints      LoyaltyPoints[]
  loyaltyProgram     LoyaltyProgram?
  prescriptions      Prescription[]
  products           Product[]
  quotes             Quote[]
  sales              Sale[]
  serviceOrders      ServiceOrder[]
  shapes             Shape[]
  stockAdjustments   StockAdjustment[]
  stockMovements     StockMovement[]
  stockReservations  StockReservation[]
  suppliers          Supplier[]
  systemRules        SystemRule[]
  users              User[]
  warranties         Warranty[]
  counters           Counter[]
  cardFeeRules       CardFeeRule[]
  cashRegisters      CashRegister[]
  frameMeasurements  FrameMeasurement[]

  // ========================================
  // NOVOS CAMPOS - SAAS MULTI-TENANT
  // ========================================

  slug                String?   @unique
  onboardingStep      Int       @default(0)
  onboardingDoneAt    DateTime?
  isBlocked           Boolean   @default(false)
  blockedReason       String?
  blockedAt           DateTime?
  leadSource          String?
  referredByCompanyId String?
  billingEmail        String?
  billingPhone        String?
  billingName         String?

  // ========================================
  // NOVAS RELAÇÕES - SAAS MULTI-TENANT
  // ========================================

  subscriptions  Subscription[]
  domains        TenantDomain[]
  usageMetrics   UsageMetric[]
  billingEvents  BillingEvent[]
  supportTickets SupportTicket[]
  impersonations ImpersonationSession[]
  globalAudits   GlobalAudit[]
  companyNotes   CompanyNote[]
  healthScores   HealthScore[]
  usageSnapshots UsageSnapshot[]

  // Health Score cache (desnormalizado para performance)
  healthScore     Int?
  healthCategory  HealthCategory?
  healthUpdatedAt DateTime?

  // ========================================
  // SPRINT 8: REDE DE LOJAS
  // ========================================
  networkId      String?
  network        Network? @relation("NetworkCompanies", fields: [networkId], references: [id])
  isHeadquarters Boolean  @default(false)
  headquartersOf Network? @relation("NetworkHeadquarters")

  // ========================================
  // SPRINT 8: ACESSO & ONBOARDING
  // ========================================
  accessEnabled         Boolean          @default(false)
  accessEnabledAt       DateTime?
  accessEnabledBy       String?
  onboardingStatus      OnboardingStatus @default(PENDING_INVITE)
  onboardingCompletedAt DateTime?

  // ========================================
  // SPRINT 8: LIMITES DO PLANO
  // ========================================
  maxUsers    Int @default(3)
  maxProducts Int @default(500)
  maxBranches Int @default(1)

  // ========================================
  // SPRINT 8: AQUISIÇÃO
  // ========================================
  acquisitionChannel String?

  // ========================================
  // SPRINT 8: NOVAS RELAÇÕES
  // ========================================
  invites Invite[]

  // ========================================
  // CAMPANHAS DE PRODUTO
  // ========================================
  productCampaigns     ProductCampaign[]
  campaignBonusEntries CampaignBonusEntry[]

  // ========================================
  // CRM / LEMBRETES
  // ========================================
  messageTemplates  MessageTemplate[]  @relation("MessageTemplates")
  customerReminders CustomerReminder[] @relation("CustomerReminders")
  crmContacts       CrmContact[]       @relation("CrmContacts")
  contactGoals      ContactGoal[]      @relation("ContactGoals")
  crmSettings       CrmSettings?       @relation("CrmSettings")

  // ========================================
  // MÓDULO FINANCEIRO
  // ========================================
  chartOfAccounts        ChartOfAccounts[]
  financeAccounts        FinanceAccount[]
  financeEntries         FinanceEntry[]
  inventoryLots          InventoryLot[]
  refunds                Refund[]
  dailyAggs              DailyAgg[]
  reconciliationBatches  ReconciliationBatch[]
  reconciliationTemplates ReconciliationTemplate[]
  reconciliationRules    ReconciliationRule[]

  // Índices
  @@index([networkId])
  @@index([onboardingStatus])
}

model Branch {
  id                   String              @id @default(cuid())
  companyId            String
  name                 String
  code                 String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  phone                String?
  stateRegistration    String?
  nfeSeries            Int?
  lastNfeNumber        Int?
  active               Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  accountsPayable      AccountPayable[]
  accountsReceivable   AccountReceivable[]
  appointments         Appointment[]
  auditLogs            AuditLog[]
  company              Company             @relation(fields: [companyId], references: [id])
  cashMovements        CashMovement[]
  shifts               CashShift[]
  cashbackConfig       CashbackConfig?
  commissionConfig     CommissionConfig?
  customerCashbacks    CustomerCashback[]
  customerContacts     CustomerContact[]
  dreReports           DREReport[]
  quotes               Quote[]
  reminders            Reminder[]
  reminderConfig       ReminderConfig?
  sales                Sale[]
  salesGoals           SalesGoal[]
  sellerCommissions    SellerCommission[]
  serviceOrders        ServiceOrder[]
  cashRegisters        CashRegister[]
  stockMovements       StockMovement[]     @relation("StockMovementBranch")
  stockMovementsSource StockMovement[]     @relation("StockMovementSource")
  stockMovementsTarget StockMovement[]     @relation("StockMovementTarget")
  stockReservations    StockReservation[]
  userBranches         UserBranch[]

  // Campanhas
  productCampaigns     ProductCampaign[]
  campaignBonusEntries CampaignBonusEntry[]
  campaignProgress     CampaignSellerProgress[]

  // CRM / Lembretes
  contactGoals ContactGoal[] @relation("BranchContactGoals")

  // Financeiro
  financeAccounts       FinanceAccount[]
  financeEntries        FinanceEntry[]
  inventoryLots         InventoryLot[]
  refunds               Refund[]
  dailyAggs             DailyAgg[]
  reconciliationBatches ReconciliationBatch[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model User {
  id                         String                @id @default(cuid())
  companyId                  String
  name                       String
  email                      String                @unique
  passwordHash               String
  role                       UserRole
  active                     Boolean               @default(true)
  defaultCommissionPercent   Decimal?              @db.Decimal(5, 2)
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  accountsPayableCreated     AccountPayable[]      @relation("AccountPayableCreator")
  accountsPayablePaid        AccountPayable[]      @relation("AccountPayablePayer")
  accountsReceivableCreated  AccountReceivable[]   @relation("AccountReceivableCreator")
  accountsReceivableReceived AccountReceivable[]   @relation("AccountReceivableReceiver")
  logs                       AuditLog[]
  cashMovementsCreated       CashMovement[]        @relation("CashMovementCreator")
  shiftsClosed               CashShift[]           @relation("ShiftCloser")
  shiftsOpened               CashShift[]           @relation("ShiftOpener")
  cashbackMovementsCreated   CashbackMovement[]    @relation("CashbackMovementCreatedBy")
  commissions                Commission[]
  contactsExecuted           CustomerContact[]     @relation("ContactExecutedBy")
  barcodesCreated            ProductBarcode[]      @relation("BarcodeCreator")
  qualityChecks              QualityChecklist[]    @relation("QualityChecker")
  quotesConverted            Quote[]               @relation("QuoteConverter")
  quotesAsSeller             Quote[]               @relation("QuoteSeller")
  remindersDismissed         Reminder[]            @relation("ReminderDismissedBy")
  salesAsSeller              Sale[]                @relation("SaleSeller")
  paymentsReceived           SalePayment[]         @relation("PaymentReceiver")
  sellerCommissions          SellerCommission[]    @relation("SellerCommissions")
  sellerGoals                SellerGoal[]
  serviceOrdersCreated       ServiceOrder[]        @relation("SOCreator")
  serviceOrdersDelivered     ServiceOrder[]        @relation("SODeliverer")
  soHistoryChanges           ServiceOrderHistory[] @relation("SOHistoryChanger")
  stockAdjustmentsApproved   StockAdjustment[]     @relation("AdjustmentApprover")
  stockAdjustmentsCreated    StockAdjustment[]     @relation("AdjustmentCreator")
  stockMovements             StockMovement[]
  company                    Company               @relation(fields: [companyId], references: [id])
  branches                   UserBranch[]
  customPermissions          UserPermission[]      @relation("UserCustomPermissions")
  prescriptionsCreated       Prescription[]        @relation("PrescriptionCreator")
  frameMeasurementsTaken     FrameMeasurement[]    @relation("FrameMeasurer")
  quoteFollowUps             QuoteFollowUp[]       @relation("QuoteFollowUpCreator")
  supportTickets             SupportTicket[]

  // Campanhas
  campaignsCreated     ProductCampaign[]        @relation("CampaignCreatedBy")
  campaignBonusEntries CampaignBonusEntry[]     @relation("BonusSeller")
  campaignProgress     CampaignSellerProgress[] @relation("CampaignProgress")

  // CRM / Lembretes
  templatesCreated  MessageTemplate[]  @relation("TemplateCreator")
  assignedReminders CustomerReminder[] @relation("AssignedReminders")
  crmContactsMade   CrmContact[]       @relation("CrmContactsMade")
  userGoals         ContactGoal[]      @relation("UserGoals")
  goalsCreated      ContactGoal[]      @relation("GoalCreator")

  @@index([companyId, role])
  @@index([companyId, name])
}

model UserBranch {
  userId   String
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@id([userId, branchId])
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  branchId   String?
  userId     String?
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  ip         String?
  createdAt  DateTime @default(now())
  branch     Branch?  @relation(fields: [branchId], references: [id])
  company    Company  @relation(fields: [companyId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([branchId, createdAt])
}

model Customer {
  id                 String                 @id @default(cuid())
  companyId          String
  name               String
  cpf                String?
  rg                 String?
  phone              String?
  phone2             String?
  email              String?
  birthDate          DateTime?
  gender             String?
  address            String?
  number             String?
  complement         String?
  neighborhood       String?
  city               String?
  state              String?
  zipCode            String?
  acceptsMarketing   Boolean                @default(true)
  referralSource     String?
  notes              String?
  active             Boolean                @default(true)
  deletedAt          DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  accountsReceivable AccountReceivable[]
  agreementBenefits  AgreementBeneficiary[]
  appointments       Appointment[]
  company            Company                @relation(fields: [companyId], references: [id])
  cashback           CustomerCashback[]
  contacts           CustomerContact[]
  dependents         CustomerDependent[]
  loyaltyPoints      LoyaltyPoints[]
  prescriptions      Prescription[]
  quotes             Quote[]
  reminders          Reminder[]
  sales              Sale[]
  serviceOrders      ServiceOrder[]

  // CRM / Lembretes
  crmReminders CustomerReminder[] @relation("CustomerReminders")
  crmContacts  CrmContact[]       @relation("CrmContacts")

  // Financeiro
  refunds Refund[]

  @@unique([companyId, cpf])
  @@index([companyId, name])
  @@index([companyId, phone])
  @@index([companyId, email])
}

model CustomerDependent {
  id           String    @id @default(cuid())
  customerId   String
  name         String
  relationship String
  birthDate    DateTime?
  cpf          String?
  createdAt    DateTime  @default(now())
  customer     Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Doctor {
  id                       String         @id @default(cuid())
  companyId                String
  name                     String
  crm                      String?
  uf                       String?
  specialty                String?
  isPartner                Boolean        @default(false)
  partnerCommissionPercent Decimal?       @db.Decimal(5, 2)
  phone                    String?
  email                    String?
  clinicName               String?
  clinicAddress            String?
  active                   Boolean        @default(true)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  company                  Company        @relation(fields: [companyId], references: [id])
  prescriptions            Prescription[]

  @@unique([companyId, crm, uf])
  @@index([companyId, name])
}

model Lab {
  id                  String              @id @default(cuid())
  companyId           String
  name                String
  code                String?
  cnpj                String?
  phone               String?
  email               String?
  orderEmail          String?
  website             String?
  contactPerson       String?
  integrationType     String?
  apiUrl              String?
  apiKey              String?
  clientCode          String?
  defaultLeadTimeDays Int                 @default(7)
  urgentLeadTimeDays  Int                 @default(3)
  paymentTermDays     Int                 @default(30)
  defaultDiscount     Decimal             @default(0) @db.Decimal(5, 2)
  qualityRating       Decimal?            @db.Decimal(3, 2)
  totalOrders         Int                 @default(0)
  totalReworks        Int                 @default(0)
  active              Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  company             Company             @relation(fields: [companyId], references: [id])
  priceRanges         LabPriceRange[]
  lensServices        LensServiceDetail[]
  serviceOrders       ServiceOrder[]
  serviceOrderItems   ServiceOrderItem[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model LensTreatment {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation("CompanyLensTreatments", fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId, active])
}

model LabPriceRange {
  id                String   @id @default(cuid())
  labId             String
  lensType          String
  material          String
  sphMin            Decimal? @db.Decimal(5, 2)
  sphMax            Decimal? @db.Decimal(5, 2)
  cylMin            Decimal? @db.Decimal(5, 2)
  cylMax            Decimal? @db.Decimal(5, 2)
  labPrice          Decimal  @db.Decimal(12, 2)
  suggestedPrice    Decimal? @db.Decimal(12, 2)
  arPrice           Decimal? @db.Decimal(12, 2)
  blueLightPrice    Decimal? @db.Decimal(12, 2)
  photochromicPrice Decimal? @db.Decimal(12, 2)
  leadTimeDays      Int?
  active            Boolean  @default(true)
  lab               Lab      @relation(fields: [labId], references: [id])

  @@index([labId, lensType, material])
}

model Supplier {
  id              String           @id @default(cuid())
  companyId       String
  name            String
  tradeName       String?
  cnpj            String?
  phone           String?
  email           String?
  website         String?
  contactPerson   String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  notes           String?
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  accountsPayable AccountPayable[]
  products        Product[]
  stockMovements  StockMovement[]
  company         Company          @relation(fields: [companyId], references: [id])

  // Campanhas
  campaignItems ProductCampaignItem[]

  // Financeiro
  inventoryLots InventoryLot[] @relation("LotSupplier")

  @@unique([companyId, cnpj])
  @@index([companyId, name])
}

model Category {
  id                       String     @id @default(cuid())
  companyId                String
  name                     String
  parentId                 String?
  defaultCommissionPercent Decimal?   @db.Decimal(5, 2)
  minMarginPercent         Decimal?   @db.Decimal(5, 2)
  active                   Boolean    @default(true)
  company                  Company    @relation(fields: [companyId], references: [id])
  parent                   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children                 Category[] @relation("CategoryHierarchy")
  products                 Product[]

  // Campanhas
  campaignItems ProductCampaignItem[]

  @@unique([companyId, name])
}

model Brand {
  id           String    @id @default(cuid())
  companyId    String
  code         String
  name         String
  manufacturer String?
  minMargin    Decimal?  @db.Decimal(5, 2)
  maxDiscount  Decimal?  @db.Decimal(5, 2)
  segment      String?
  origin       String?
  logoPath     String?
  website      String?
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  company      Company   @relation(fields: [companyId], references: [id])
  products     Product[]

  // Campanhas
  campaignItems ProductCampaignItem[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model Shape {
  id          String    @id @default(cuid())
  companyId   String
  code        String
  name        String
  description String?
  imageUrl    String?
  faceTypes   String[]
  active      Boolean   @default(true)
  products    Product[]
  company     Company   @relation(fields: [companyId], references: [id])

  @@unique([companyId, code])
}

model Color {
  id        String    @id @default(cuid())
  companyId String
  code      String
  name      String
  hex       String?
  active    Boolean   @default(true)
  company   Company   @relation(fields: [companyId], references: [id])
  products  Product[]

  @@unique([companyId, code])
}

model Product {
  id                String             @id @default(cuid())
  companyId         String
  type              ProductType
  sku               String
  barcode           String?
  manufacturerCode  String?
  name              String
  description       String?
  categoryId        String?
  brandId           String?
  shapeId           String?
  colorId           String?
  costPrice         Decimal            @default(0) @db.Decimal(12, 2)
  salePrice         Decimal            @db.Decimal(12, 2)
  promoPrice        Decimal?           @db.Decimal(12, 2)
  marginPercent     Decimal?           @db.Decimal(5, 2)
  stockControlled   Boolean            @default(true)
  stockQty          Int                @default(0)
  stockMin          Int                @default(0)
  stockMax          Int?
  reorderPoint      Int?
  abcClass          String?
  turnoverDays      Int?
  ncm               String?
  cest              String?
  mainImage         String?
  images            String[]
  active            Boolean            @default(true)
  featured          Boolean            @default(false)
  launch            Boolean            @default(false)
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  supplierId        String?
  accessoryDetail   AccessoryDetail?
  contactLensDetail ContactLensDetail?
  frameDetail       FrameDetail?
  lensServiceDetail LensServiceDetail?
  brand             Brand?             @relation(fields: [brandId], references: [id])
  category          Category?          @relation(fields: [categoryId], references: [id])
  color             Color?             @relation(fields: [colorId], references: [id])
  company           Company            @relation(fields: [companyId], references: [id])
  shape             Shape?             @relation(fields: [shapeId], references: [id])
  supplier          Supplier?          @relation(fields: [supplierId], references: [id])
  barcodes          ProductBarcode[]
  quoteItems        QuoteItem[]
  saleItems         SaleItem[]
  serviceDetail     ServiceDetail?
  serviceOrderItems ServiceOrderItem[]
  stockAdjustments  StockAdjustment[]
  stockMovements    StockMovement[]
  stockReservations StockReservation[]

  // Campanhas
  campaignItems ProductCampaignItem[]

  // Financeiro
  inventoryLots InventoryLot[]

  @@unique([companyId, sku])
  @@index([companyId, name])
  @@index([companyId, barcode])
  @@index([companyId, type])
  @@index([companyId, abcClass])
}

model FrameDetail {
  productId   String  @id
  lensWidthMm Int?
  bridgeMm    Int?
  templeMm    Int?
  sizeText    String?
  material    String?
  gender      String?
  collection  String?
  product     Product @relation(fields: [productId], references: [id])
}

model ContactLensDetail {
  productId  String  @id
  brandModel String?
  type       String?
  material   String?
  baseCurve  String?
  diameter   String?
  packQty    Int?
  sphRange   String?
  cylRange   String?
  axisRange  String?
  addRange   String?
  color      String?
  product    Product @relation(fields: [productId], references: [id])
}

model AccessoryDetail {
  productId String  @id
  subtype   String?
  product   Product @relation(fields: [productId], references: [id])
}

model ServiceDetail {
  productId   String  @id
  serviceType String?
  durationMin Int?
  product     Product @relation(fields: [productId], references: [id])
}

model LensServiceDetail {
  productId       String   @id
  labId           String?
  lensType        String?
  material        String?
  refractionIndex Decimal? @db.Decimal(5, 2)
  treatments      Json?
  leadTimeDays    Int?
  lab             Lab?     @relation(fields: [labId], references: [id])
  product         Product  @relation(fields: [productId], references: [id])
}

model Prescription {
  id               String              @id @default(cuid())
  companyId        String
  customerId       String
  doctorId         String?
  issuedAt         DateTime
  expiresAt        DateTime
  prescriptionType String?
  notes            String?
  imageUrl         String?
  createdByUserId  String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  company          Company             @relation(fields: [companyId], references: [id])
  customer         Customer            @relation(fields: [customerId], references: [id])
  doctor           Doctor?             @relation(fields: [doctorId], references: [id])
  createdByUser    User?               @relation("PrescriptionCreator", fields: [createdByUserId], references: [id])
  values           PrescriptionValues?
  serviceOrders    ServiceOrder[]      @relation("SOPrescription")

  @@index([companyId, customerId])
  @@index([customerId, expiresAt])
}

model PrescriptionValues {
  id               String       @id @default(cuid())
  prescriptionId   String       @unique
  odSph            Decimal?     @db.Decimal(6, 2)
  odCyl            Decimal?     @db.Decimal(6, 2)
  odAxis           Int?
  odAdd            Decimal?     @db.Decimal(6, 2)
  odPrism          Decimal?     @db.Decimal(6, 2)
  odBase           String?
  oeSph            Decimal?     @db.Decimal(6, 2)
  oeCyl            Decimal?     @db.Decimal(6, 2)
  oeAxis           Int?
  oeAdd            Decimal?     @db.Decimal(6, 2)
  oePrism          Decimal?     @db.Decimal(6, 2)
  oeBase           String?
  pdFar            Decimal?     @db.Decimal(5, 2)
  pdNear           Decimal?     @db.Decimal(5, 2)
  fittingHeightOd  Decimal?     @db.Decimal(5, 2)
  fittingHeightOe  Decimal?     @db.Decimal(5, 2)
  pantoscopicAngle Decimal?     @db.Decimal(5, 2)
  vertexDistance   Decimal?     @db.Decimal(5, 2)
  frameCurvature   Decimal?     @db.Decimal(5, 2)
  prescription     Prescription @relation(fields: [prescriptionId], references: [id])
}

model ServiceOrder {
  id              String  @id @default(cuid())
  number          Int     @default(0) // Número sequencial por empresa (gerado no service)
  companyId       String
  branchId        String
  customerId      String
  prescriptionId  String?
  createdByUserId String

  // === STATUS E PRIORIDADE ===
  status   ServiceOrderStatus   @default(DRAFT)
  priority ServiceOrderPriority @default(NORMAL)

  // === DATAS DO FLUXO ===
  promisedDate    DateTime? // Prazo prometido ao cliente
  labExpectedDate DateTime? // Prazo interno do laboratório
  sentToLabAt     DateTime? // Quando foi enviada ao lab
  readyAt         DateTime? // Quando ficou pronta
  deliveredAt     DateTime? // Quando foi entregue ao cliente
  canceledAt      DateTime? // Quando foi cancelada

  // === LABORATÓRIO ===
  laboratoryId   String?
  labOrderNumber String? // Número do pedido no laboratório
  labNotes       String? // Observações para o lab

  // === ATRASO ===
  isDelayed   Boolean @default(false)
  delayDays   Int?
  delayReason String?

  // === GARANTIA / RETRABALHO ===
  isWarranty      Boolean        @default(false)
  isRework        Boolean        @default(false)
  warrantyReason  String?
  reworkReason    String?
  originalOrderId String?
  originalOrder   ServiceOrder?  @relation("OrderRework", fields: [originalOrderId], references: [id])
  reworkOrders    ServiceOrder[] @relation("OrderRework")

  // === ENTREGA ===
  deliveredByUserId String?
  deliveryNotes     String?

  // === QUALIDADE ===
  qualityRating Int? // 1-5 estrelas
  qualityNotes  String?

  // === DADOS ===
  prescriptionData Json?
  notes            String?
  deletedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // === RELAÇÕES ===
  company           Company               @relation(fields: [companyId], references: [id])
  branch            Branch                @relation(fields: [branchId], references: [id])
  customer          Customer              @relation(fields: [customerId], references: [id])
  prescriptionRel   Prescription?         @relation("SOPrescription", fields: [prescriptionId], references: [id])
  laboratory        Lab?                  @relation(fields: [laboratoryId], references: [id])
  createdByUser     User                  @relation("SOCreator", fields: [createdByUserId], references: [id])
  deliveredByUser   User?                 @relation("SODeliverer", fields: [deliveredByUserId], references: [id])
  qualityChecklist  QualityChecklist?
  sale              Sale?
  items             ServiceOrderItem[]
  history           ServiceOrderHistory[]
  reservations      StockReservation[]
  warranties        Warranty[]
  frameMeasurements FrameMeasurement[]
  warrantyClaims    WarrantyClaim[]       @relation("WarrantyClaimOrder")

  @@unique([companyId, number])
  @@index([companyId, status])
  @@index([companyId, customerId])
  @@index([companyId, isDelayed])
  @@index([companyId, promisedDate])
  @@index([laboratoryId])
}

model ServiceOrderItem {
  id                   String       @id @default(cuid())
  serviceOrderId       String
  productId            String?
  labId                String?
  description          String?
  qty                  Int          @default(1)
  unitPrice            Decimal      @db.Decimal(12, 2)
  discount             Decimal      @default(0) @db.Decimal(12, 2)
  lineTotal            Decimal      @db.Decimal(12, 2)
  costEstimated        Decimal?     @db.Decimal(12, 2)
  measurementsSnapshot Json?
  createdAt            DateTime     @default(now())
  lab                  Lab?         @relation(fields: [labId], references: [id])
  product              Product?     @relation(fields: [productId], references: [id])
  serviceOrder         ServiceOrder @relation(fields: [serviceOrderId], references: [id])
  warranties           Warranty[]

  @@index([serviceOrderId])
}

model ServiceOrderHistory {
  id              String              @id @default(cuid())
  serviceOrderId  String
  action          String // STATUS_CHANGED, REVERTED, EDITED, DELIVERED, CREATED, CANCELED
  fromStatus      ServiceOrderStatus?
  toStatus        ServiceOrderStatus?
  note            String?
  metadata        Json? // Dados extras para auditoria
  changedByUserId String?
  createdAt       DateTime            @default(now())
  changedByUser   User?               @relation("SOHistoryChanger", fields: [changedByUserId], references: [id])
  serviceOrder    ServiceOrder        @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId, createdAt])
}

model QualityChecklist {
  id                String       @id @default(cuid())
  serviceOrderId    String       @unique
  lensGradeOk       Boolean      @default(false)
  lensCenteringOk   Boolean      @default(false)
  lensHeightOk      Boolean      @default(false)
  treatmentsOk      Boolean      @default(false)
  frameAdjustmentOk Boolean      @default(false)
  cleaningOk        Boolean      @default(false)
  notes             String?
  checkedByUserId   String?
  checkedAt         DateTime?
  customerApproved  Boolean      @default(false)
  checkedByUser     User?        @relation("QualityChecker", fields: [checkedByUserId], references: [id])
  serviceOrder      ServiceOrder @relation(fields: [serviceOrderId], references: [id])
}

model StockReservation {
  id             String                 @id @default(cuid())
  companyId      String
  branchId       String
  productId      String
  serviceOrderId String?
  saleId         String?
  qty            Int
  status         StockReservationStatus @default(RESERVED)
  createdAt      DateTime               @default(now())
  releasedAt     DateTime?
  consumedAt     DateTime?
  branch         Branch                 @relation(fields: [branchId], references: [id])
  company        Company                @relation(fields: [companyId], references: [id])
  product        Product                @relation(fields: [productId], references: [id])
  sale           Sale?                  @relation(fields: [saleId], references: [id])
  serviceOrder   ServiceOrder?          @relation(fields: [serviceOrderId], references: [id])

  @@index([branchId, productId, status])
  @@index([serviceOrderId])
  @@index([saleId])
}

model StockMovement {
  id              String            @id @default(cuid())
  companyId       String
  branchId        String? // Filial onde a movimentação ocorreu
  productId       String
  type            StockMovementType
  quantity        Int
  supplierId      String?
  invoiceNumber   String?
  sourceBranchId  String?
  targetBranchId  String?
  reason          String?
  notes           String?
  createdByUserId String?
  createdAt       DateTime          @default(now())
  branch          Branch?           @relation("StockMovementBranch", fields: [branchId], references: [id])
  company         Company           @relation(fields: [companyId], references: [id])
  createdBy       User?             @relation(fields: [createdByUserId], references: [id])
  product         Product           @relation(fields: [productId], references: [id])
  sourceBranch    Branch?           @relation("StockMovementSource", fields: [sourceBranchId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  targetBranch    Branch?           @relation("StockMovementTarget", fields: [targetBranchId], references: [id])

  @@index([companyId, productId, createdAt])
  @@index([companyId, type, createdAt])
  @@index([branchId, createdAt])
  @@index([productId, createdAt])
  @@index([supplierId, createdAt])
}

model QuoteFollowUp {
  id      String @id @default(cuid())
  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id])

  channel String // WHATSAPP, PHONE, EMAIL, SMS, IN_PERSON
  notes   String?
  outcome String? // INTERESTED, NOT_INTERESTED, CALLBACK, NO_ANSWER, CONVERTED

  scheduledAt DateTime? // Se agendou retorno
  contactedAt DateTime  @default(now())

  createdByUserId String
  createdBy       User   @relation("QuoteFollowUpCreator", fields: [createdByUserId], references: [id])

  @@index([quoteId, contactedAt])
}

model Quote {
  id                String          @id @default(cuid())
  companyId         String
  branchId          String
  customerId        String?
  sellerUserId      String
  status            QuoteStatus     @default(PENDING)
  validUntil        DateTime?
  notes             String?
  subtotal          Decimal         @default(0) @db.Decimal(12, 2)
  discountTotal     Decimal         @default(0) @db.Decimal(12, 2)
  total             Decimal         @default(0) @db.Decimal(12, 2)
  lastFollowUpAt    DateTime?
  followUpCount     Int             @default(0)
  conversionReason  String?
  convertedToSaleId String?         @unique
  convertedToOsId   String?
  deletedAt         DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  convertedAt       DateTime?
  convertedByUserId String?
  customerEmail     String?
  customerName      String?
  customerPhone     String?
  discountPercent   Decimal         @default(0) @db.Decimal(5, 2)
  internalNotes     String?
  lostReason        String?
  paymentConditions String?
  contactCount      Int             @default(0)
  followUpDate      DateTime?
  followUpNotes     String?
  lastContactAt     DateTime?
  sentAt            DateTime?
  sentVia           String?
  branch            Branch          @relation(fields: [branchId], references: [id])
  company           Company         @relation(fields: [companyId], references: [id])
  convertedBy       User?           @relation("QuoteConverter", fields: [convertedByUserId], references: [id])
  customer          Customer?       @relation(fields: [customerId], references: [id])
  sellerUser        User            @relation("QuoteSeller", fields: [sellerUserId], references: [id])
  items             QuoteItem[]
  convertedToSale   Sale?           @relation("QuoteToSale")
  followUps         QuoteFollowUp[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@index([customerId])
  @@index([validUntil])
  @@index([sellerUserId])
  @@index([branchId, status, createdAt])
  @@index([status, validUntil])
}

model QuoteItem {
  id               String        @id @default(cuid())
  quoteId          String
  productId        String?
  description      String
  qty              Int           @default(1)
  unitPrice        Decimal       @db.Decimal(12, 2)
  discount         Decimal       @default(0) @db.Decimal(12, 2)
  createdAt        DateTime      @default(now())
  itemType         QuoteItemType @default(PRODUCT)
  notes            String?
  prescriptionData Json?
  total            Decimal       @db.Decimal(12, 2)
  product          Product?      @relation(fields: [productId], references: [id])
  quote            Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Sale {
  id                   String              @id @default(cuid())
  companyId            String
  branchId             String
  customerId           String?
  serviceOrderId       String?             @unique
  sellerUserId         String
  status               SaleStatus          @default(OPEN)
  subtotal             Decimal             @default(0) @db.Decimal(12, 2)
  discountTotal        Decimal             @default(0) @db.Decimal(12, 2)
  total                Decimal             @default(0) @db.Decimal(12, 2)
  agreementId          String?
  agreementDiscount    Decimal?            @db.Decimal(12, 2)
  authorizationCode    String?
  fiscalStatus         FiscalStatus        @default(NOT_REQUESTED)
  fiscalModel          String?
  fiscalKey            String?
  fiscalXmlUrl         String?
  fiscalPdfUrl         String?
  completedAt          DateTime?
  deletedAt            DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  convertedFromQuoteId String?             @unique
  cashbackUsed         Decimal             @default(0) @db.Decimal(10, 2)
  accountsReceivable   AccountReceivable[]
  cashbackMovements    CashbackMovement[]
  commissions          Commission[]
  agreement            Agreement?          @relation(fields: [agreementId], references: [id])
  branch               Branch              @relation(fields: [branchId], references: [id])
  company              Company             @relation(fields: [companyId], references: [id])
  convertedFromQuote   Quote?              @relation("QuoteToSale", fields: [convertedFromQuoteId], references: [id])
  customer             Customer?           @relation(fields: [customerId], references: [id])
  sellerUser           User                @relation("SaleSeller", fields: [sellerUserId], references: [id])
  serviceOrder         ServiceOrder?       @relation(fields: [serviceOrderId], references: [id])
  items                SaleItem[]
  payments             SalePayment[]
  reservations         StockReservation[]
  warranties           Warranty[]

  // Campanhas
  campaignBonusEntries CampaignBonusEntry[]

  // Financeiro
  refunds Refund[]

  @@index([companyId, branchId, createdAt])
  @@index([customerId, createdAt])
  @@index([sellerUserId, createdAt])
  @@index([agreementId])
}

model SaleItem {
  id               String     @id @default(cuid())
  saleId           String
  productId        String?
  description      String?
  qty              Int        @default(1)
  unitPrice        Decimal    @db.Decimal(12, 2)
  discount         Decimal    @default(0) @db.Decimal(12, 2)
  lineTotal        Decimal    @db.Decimal(12, 2)
  costPrice        Decimal    @default(0) @db.Decimal(12, 2)
  stockControlled  Boolean    @default(true)
  stockQtyConsumed Int        @default(0)
  createdAt        DateTime   @default(now())
  product          Product?   @relation(fields: [productId], references: [id])
  sale             Sale       @relation(fields: [saleId], references: [id])
  warranties       Warranty[]

  // Campanhas
  campaignBonusEntries CampaignBonusEntry[]

  // Financeiro
  lotConsumptions SaleItemLot[]
  refundItems     RefundItem[]

  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id               String        @id @default(cuid())
  saleId           String
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)
  amount           Decimal       @db.Decimal(12, 2)
  installments     Int?
  cardBrand        String?
  reference        String?
  details          Json?
  receivedAt       DateTime?
  receivedByUserId String?
  createdAt        DateTime      @default(now())

  // Campos de conciliação de cartão
  cardLastDigits    String? // Últimos 4 dígitos
  authorizationCode String? // Código de autorização
  nsu               String? // NSU da transação
  feePercent        Decimal?  @db.Decimal(5, 4)
  feeAmount         Decimal?  @db.Decimal(10, 2)
  netAmount         Decimal?  @db.Decimal(10, 2)
  settlementDate    DateTime? // Data prevista de recebimento
  settledAt         DateTime? // Data real do recebimento
  settlementStatus  String?   @default("PENDING") // PENDING, SETTLED, FAILED
  acquirer          String? // CIELO, REDE, STONE, PAGSEGURO, etc.

  cashMovements  CashMovement[]
  receivedByUser User?          @relation("PaymentReceiver", fields: [receivedByUserId], references: [id])
  sale           Sale           @relation(fields: [saleId], references: [id])

  // Conciliação
  reconciliationItems ReconciliationItem[]

  @@index([saleId, status])
  @@index([method, status])
  @@index([settlementDate, settlementStatus])
  @@index([nsu])
  @@index([authorizationCode])
}

model CommissionRule {
  id               String   @id @default(cuid())
  companyId        String
  name             String
  userId           String?
  categoryId       String?
  brandId          String?
  percentage       Decimal  @db.Decimal(5, 2)
  minMarginPercent Decimal? @db.Decimal(5, 2)
  priority         Int      @default(0)
  active           Boolean  @default(true)
  company          Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, active])
}

model Commission {
  id               String           @id @default(cuid())
  companyId        String
  saleId           String
  userId           String
  baseAmount       Decimal          @db.Decimal(12, 2)
  percentage       Decimal          @db.Decimal(5, 2)
  commissionAmount Decimal          @db.Decimal(12, 2)
  status           CommissionStatus @default(PENDING)
  periodMonth      Int
  periodYear       Int
  approvedAt       DateTime?
  approvedByUserId String?
  paidAt           DateTime?
  paidByUserId     String?
  paymentMethod    String?
  paymentReference String?
  notes            String?
  createdAt        DateTime         @default(now())
  company          Company          @relation(fields: [companyId], references: [id])
  sale             Sale             @relation(fields: [saleId], references: [id])
  user             User             @relation(fields: [userId], references: [id])

  @@index([companyId, periodYear, periodMonth])
  @@index([userId, status])
  @@index([saleId])
}

model CashShift {
  id                      String          @id @default(cuid())
  companyId               String
  branchId                String
  status                  CashShiftStatus @default(OPEN)
  openedByUserId          String
  openedAt                DateTime        @default(now())
  openingFloatAmount      Decimal         @default(0) @db.Decimal(12, 2)
  closedByUserId          String?
  closedAt                DateTime?
  closingDeclaredCash     Decimal?        @db.Decimal(12, 2)
  closingExpectedCash     Decimal?        @db.Decimal(12, 2)
  differenceCash          Decimal?        @db.Decimal(12, 2)
  differenceJustification String?
  notes                   String?
  cashRegisterId          String?
  movements               CashMovement[]
  branch                  Branch          @relation(fields: [branchId], references: [id])
  cashRegister            CashRegister?   @relation(fields: [cashRegisterId], references: [id])
  closedByUser            User?           @relation("ShiftCloser", fields: [closedByUserId], references: [id])
  company                 Company         @relation(fields: [companyId], references: [id])
  openedByUser            User            @relation("ShiftOpener", fields: [openedByUserId], references: [id])

  @@index([branchId, status])
  @@index([companyId, openedAt])
  @@index([cashRegisterId, status])
}

model CashMovement {
  id              String           @id @default(cuid())
  cashShiftId     String
  branchId        String
  type            CashMovementType
  direction       CashDirection
  method          PaymentMethod
  amount          Decimal          @db.Decimal(12, 2)
  originType      String
  originId        String
  salePaymentId   String?
  createdByUserId String?
  note            String?
  createdAt       DateTime         @default(now())
  migrated        Boolean          @default(false)
  branch          Branch           @relation(fields: [branchId], references: [id])
  cashShift       CashShift        @relation(fields: [cashShiftId], references: [id])
  createdByUser   User?            @relation("CashMovementCreator", fields: [createdByUserId], references: [id])
  salePayment     SalePayment?     @relation(fields: [salePaymentId], references: [id])

  @@index([cashShiftId, createdAt])
  @@index([originType, originId])
  @@index([method, type])
}

model Warranty {
  id                 String            @id @default(cuid())
  companyId          String
  saleId             String?
  saleItemId         String?
  serviceOrderId     String?
  serviceOrderItemId String?
  warrantyType       WarrantyType
  status             WarrantyStatus    @default(ACTIVE)
  startAt            DateTime
  expiresAt          DateTime
  termsDescription   String?
  notes              String?
  company            Company           @relation(fields: [companyId], references: [id])
  sale               Sale?             @relation(fields: [saleId], references: [id])
  saleItem           SaleItem?         @relation(fields: [saleItemId], references: [id])
  serviceOrder       ServiceOrder?     @relation(fields: [serviceOrderId], references: [id])
  serviceOrderItem   ServiceOrderItem? @relation(fields: [serviceOrderItemId], references: [id])
  claims             WarrantyClaim[]

  @@index([companyId, status, expiresAt])
  @@index([saleId])
  @@index([serviceOrderId])
}

model WarrantyClaim {
  id                 String              @id @default(cuid())
  warrantyId         String
  openedAt           DateTime            @default(now())
  reason             String
  problemDescription String?
  resolution         String?
  resolutionType     String?
  filesUrl           String[]
  status             WarrantyClaimStatus @default(PENDING)
  warrantyOrderId    String? // OS criada para executar a garantia
  analyzedByUserId   String?
  analyzedAt         DateTime?
  closedAt           DateTime?
  closedByUserId     String?
  notes              String?
  warranty           Warranty            @relation(fields: [warrantyId], references: [id])
  warrantyOrder      ServiceOrder?       @relation("WarrantyClaimOrder", fields: [warrantyOrderId], references: [id])

  @@index([warrantyId])
  @@index([status])
}

model Appointment {
  id                 String            @id @default(cuid())
  companyId          String
  branchId           String
  customerId         String?
  contactName        String?
  contactPhone       String?
  type               AppointmentType
  status             AppointmentStatus @default(SCHEDULED)
  scheduledAt        DateTime
  scheduledEndAt     DateTime?
  durationMinutes    Int               @default(30)
  serviceOrderId     String?
  assignedUserId     String?
  confirmed          Boolean           @default(false)
  confirmedAt        DateTime?
  confirmationMethod String?
  reminderSent       Boolean           @default(false)
  reminderSentAt     DateTime?
  checkinAt          DateTime?
  checkoutAt         DateTime?
  attendedByUserId   String?
  notes              String?
  internalNotes      String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  branch             Branch            @relation(fields: [branchId], references: [id])
  company            Company           @relation(fields: [companyId], references: [id])
  customer           Customer?         @relation(fields: [customerId], references: [id])

  @@index([branchId, scheduledAt])
  @@index([customerId, scheduledAt])
  @@index([status, scheduledAt])
}

model Agreement {
  id                String                 @id @default(cuid())
  companyId         String
  code              String
  name              String
  type              AgreementType
  cnpj              String?
  phone             String?
  email             String?
  contactPerson     String?
  discountPercent   Decimal                @default(0) @db.Decimal(5, 2)
  paymentTermDays   Int                    @default(30)
  billingDay        Int?
  minPurchase       Decimal?               @db.Decimal(12, 2)
  maxPurchase       Decimal?               @db.Decimal(12, 2)
  monthlyLimit      Decimal?               @db.Decimal(12, 2)
  contractPath      String?
  contractStartDate DateTime?
  contractEndDate   DateTime?
  notes             String?
  active            Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  company           Company                @relation(fields: [companyId], references: [id])
  beneficiaries     AgreementBeneficiary[]
  sales             Sale[]

  @@unique([companyId, code])
  @@index([companyId, active])
}

model AgreementBeneficiary {
  id               String    @id @default(cuid())
  agreementId      String
  customerId       String
  enrollmentNumber String?
  isHolder         Boolean   @default(true)
  holderId         String?
  enrolledAt       DateTime  @default(now())
  validUntil       DateTime?
  active           Boolean   @default(true)
  agreement        Agreement @relation(fields: [agreementId], references: [id])
  customer         Customer  @relation(fields: [customerId], references: [id])

  @@unique([agreementId, customerId])
  @@index([customerId])
}

model LoyaltyProgram {
  id                 String        @id @default(cuid())
  companyId          String        @unique
  name               String
  description        String?
  pointsPerReal      Decimal       @default(1) @db.Decimal(5, 2)
  reaisPerPoint      Decimal       @default(10) @db.Decimal(5, 2)
  pointsExpire       Boolean       @default(true)
  expirationDays     Int           @default(365)
  minRedemption      Int           @default(100)
  birthdayMultiplier Decimal       @default(2) @db.Decimal(3, 2)
  active             Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  company            Company       @relation(fields: [companyId], references: [id])
  tiers              LoyaltyTier[]
}

model LoyaltyTier {
  id               String         @id @default(cuid())
  programId        String
  name             String
  minPoints        Int
  discountPercent  Decimal        @default(0) @db.Decimal(5, 2)
  pointsMultiplier Decimal        @default(1) @db.Decimal(3, 2)
  priorityService  Boolean        @default(false)
  exclusiveGifts   Boolean        @default(false)
  badgeColor       String?
  icon             String?
  sortOrder        Int
  active           Boolean        @default(true)
  program          LoyaltyProgram @relation(fields: [programId], references: [id])

  @@index([programId])
}

model LoyaltyPoints {
  id          String    @id @default(cuid())
  companyId   String
  customerId  String
  points      Int
  type        String
  saleId      String?
  description String?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id])
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId, createdAt])
  @@index([companyId, expiresAt])
}

model DREReport {
  id                     String   @id @default(cuid())
  companyId              String
  branchId               String?
  periodMonth            Int
  periodYear             Int
  generatedAt            DateTime @default(now())
  generatedByUserId      String?
  grossRevenue           Decimal  @default(0) @db.Decimal(14, 2)
  returns                Decimal  @default(0) @db.Decimal(14, 2)
  discounts              Decimal  @default(0) @db.Decimal(14, 2)
  netRevenue             Decimal  @default(0) @db.Decimal(14, 2)
  costOfGoodsSold        Decimal  @default(0) @db.Decimal(14, 2)
  labCosts               Decimal  @default(0) @db.Decimal(14, 2)
  grossProfit            Decimal  @default(0) @db.Decimal(14, 2)
  personnelExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  rentExpenses           Decimal  @default(0) @db.Decimal(14, 2)
  adminExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  marketingExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  financialExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  commissionExpenses     Decimal  @default(0) @db.Decimal(14, 2)
  otherExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  totalExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  operatingProfit        Decimal  @default(0) @db.Decimal(14, 2)
  taxes                  Decimal  @default(0) @db.Decimal(14, 2)
  netProfit              Decimal  @default(0) @db.Decimal(14, 2)
  grossMarginPercent     Decimal? @db.Decimal(5, 2)
  operatingMarginPercent Decimal? @db.Decimal(5, 2)
  netMarginPercent       Decimal? @db.Decimal(5, 2)
  branch                 Branch?  @relation(fields: [branchId], references: [id])
  company                Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, branchId, periodYear, periodMonth])
  @@index([companyId, periodYear, periodMonth])
}

model AccountPayable {
  id              String               @id @default(cuid())
  companyId       String
  branchId        String?
  supplierId      String?
  description     String
  category        AccountCategory
  amount          Decimal              @db.Decimal(12, 2)
  dueDate         DateTime
  paidDate        DateTime?
  paidAmount      Decimal?             @db.Decimal(12, 2)
  status          AccountPayableStatus @default(PENDING)
  invoiceNumber   String?
  notes           String?
  createdByUserId String?
  paidByUserId    String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  branch          Branch?              @relation(fields: [branchId], references: [id])
  company         Company              @relation(fields: [companyId], references: [id])
  createdBy       User?                @relation("AccountPayableCreator", fields: [createdByUserId], references: [id])
  paidBy          User?                @relation("AccountPayablePayer", fields: [paidByUserId], references: [id])
  supplier        Supplier?            @relation(fields: [supplierId], references: [id])

  @@index([companyId, status, dueDate])
  @@index([supplierId, status])
  @@index([dueDate, status])
}

model AccountReceivable {
  id                String                  @id @default(cuid())
  companyId         String
  branchId          String?
  customerId        String?
  saleId            String?
  description       String
  installmentNumber Int                     @default(1)
  totalInstallments Int                     @default(1)
  amount            Decimal                 @db.Decimal(12, 2)
  dueDate           DateTime
  receivedDate      DateTime?
  receivedAmount    Decimal?                @db.Decimal(12, 2)
  status            AccountReceivableStatus @default(PENDING)
  notes             String?
  createdByUserId   String?
  receivedByUserId  String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  branch            Branch?                 @relation(fields: [branchId], references: [id])
  company           Company                 @relation(fields: [companyId], references: [id])
  createdBy         User?                   @relation("AccountReceivableCreator", fields: [createdByUserId], references: [id])
  customer          Customer?               @relation(fields: [customerId], references: [id])
  receivedBy        User?                   @relation("AccountReceivableReceiver", fields: [receivedByUserId], references: [id])
  sale              Sale?                   @relation(fields: [saleId], references: [id])

  // Conciliação
  reconciliationItems ReconciliationItem[]

  @@index([companyId, status, dueDate])
  @@index([customerId, status])
  @@index([saleId])
  @@index([dueDate, status])
}

model StockAdjustment {
  id               String                @id @default(cuid())
  companyId        String
  productId        String
  type             StockAdjustmentType
  status           StockAdjustmentStatus @default(PENDING)
  quantityBefore   Int
  quantityChange   Int
  quantityAfter    Int
  unitCost         Decimal               @db.Decimal(12, 2)
  totalValue       Decimal               @db.Decimal(12, 2)
  reason           String
  attachments      String[]
  createdByUserId  String
  approvedByUserId String?
  approvedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  approvedBy       User?                 @relation("AdjustmentApprover", fields: [approvedByUserId], references: [id])
  company          Company               @relation(fields: [companyId], references: [id])
  createdBy        User                  @relation("AdjustmentCreator", fields: [createdByUserId], references: [id])
  product          Product               @relation(fields: [productId], references: [id])

  @@index([companyId, status, createdAt])
  @@index([productId, createdAt])
  @@index([createdByUserId])
  @@index([status, totalValue])
}

model SystemRule {
  id          String       @id @default(cuid())
  companyId   String
  category    RuleCategory
  key         String
  value       Json
  description String?
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  company     Company      @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId, category])
}

model ProductBarcode {
  id              String      @id @default(cuid())
  productId       String
  type            BarcodeType
  code            String
  isPrimary       Boolean     @default(false)
  createdByUserId String?
  createdAt       DateTime    @default(now())
  createdBy       User?       @relation("BarcodeCreator", fields: [createdByUserId], references: [id])
  product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, code])
  @@index([code])
  @@index([productId, isPrimary])
}

model Permission {
  id           String           @id @default(cuid())
  code         String           @unique
  name         String
  description  String?
  module       String
  category     String
  sortOrder    Int              @default(0)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  roleDefaults RolePermission[]
  userCustoms  UserPermission[]

  @@index([module])
  @@index([category])
  @@index([isActive])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         String
  permissionId String
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
}

model UserPermission {
  id              String     @id @default(cuid())
  userId          String
  permissionId    String
  granted         Boolean
  grantedByUserId String?
  grantedAt       DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  permission      Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user            User       @relation("UserCustomPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model CompanySettings {
  id                    String   @id @default(cuid())
  companyId             String   @unique
  displayName           String?
  cnpj                  String?
  phone                 String?
  whatsapp              String?
  email                 String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  logoUrl               String?
  messageThankYou       String?
  messageQuote          String?
  messageReminder       String?
  messageBirthday       String?
  pdfHeaderText         String?
  pdfFooterText         String?
  defaultQuoteValidDays Int      @default(15)
  defaultPaymentTerms   String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  primaryColor          String?
  company               Company  @relation("CompanySettings", fields: [companyId], references: [id])

  @@index([companyId])
}

model CashbackConfig {
  id                    String   @id @default(cuid())
  branchId              String   @unique
  enabled               Boolean  @default(false)
  earnPercent           Decimal  @default(3) @db.Decimal(5, 2)
  minPurchaseToEarn     Decimal  @default(100) @db.Decimal(10, 2)
  maxCashbackPerSale    Decimal? @db.Decimal(10, 2)
  expirationDays        Int      @default(90)
  minPurchaseMultiplier Decimal  @default(3) @db.Decimal(3, 1)
  maxUsagePercent       Decimal  @default(50) @db.Decimal(5, 2)
  birthdayMultiplier    Decimal  @default(2) @db.Decimal(3, 1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  branch                Branch   @relation(fields: [branchId], references: [id])
}

model CustomerCashback {
  id           String             @id @default(cuid())
  customerId   String
  branchId     String
  balance      Decimal            @default(0) @db.Decimal(10, 2)
  totalEarned  Decimal            @default(0) @db.Decimal(10, 2)
  totalUsed    Decimal            @default(0) @db.Decimal(10, 2)
  totalExpired Decimal            @default(0) @db.Decimal(10, 2)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  movements    CashbackMovement[]
  branch       Branch             @relation(fields: [branchId], references: [id])
  customer     Customer           @relation(fields: [customerId], references: [id])

  @@unique([customerId, branchId])
  @@index([customerId])
  @@index([branchId])
}

model CashbackMovement {
  id                 String               @id @default(cuid())
  customerCashbackId String
  type               CashbackMovementType
  amount             Decimal              @db.Decimal(10, 2)
  saleId             String?
  expiresAt          DateTime?
  expired            Boolean              @default(false)
  description        String?
  createdAt          DateTime             @default(now())
  createdByUserId    String?
  createdByUser      User?                @relation("CashbackMovementCreatedBy", fields: [createdByUserId], references: [id])
  customerCashback   CustomerCashback     @relation(fields: [customerCashbackId], references: [id])
  sale               Sale?                @relation(fields: [saleId], references: [id])

  @@index([customerCashbackId])
  @@index([saleId])
  @@index([expiresAt])
}

model ReminderConfig {
  id                              String   @id @default(cuid())
  branchId                        String   @unique
  prescriptionReminderEnabled     Boolean  @default(true)
  prescriptionReminderDays        Int      @default(30)
  prescriptionValidityMonths      Int      @default(12)
  inactiveReminderEnabled         Boolean  @default(true)
  inactiveAfterDays               Int      @default(180)
  birthdayReminderEnabled         Boolean  @default(true)
  birthdayReminderDaysBefore      Int      @default(0)
  cashbackExpiringReminderEnabled Boolean  @default(true)
  cashbackExpiringDaysBefore      Int      @default(7)
  enabledReminderTypes            String[]
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  branch                          Branch   @relation(fields: [branchId], references: [id])
}

model CustomerContact {
  id               String         @id @default(cuid())
  customerId       String
  branchId         String
  type             ContactType
  channel          ContactChannel @default(WHATSAPP)
  status           ContactStatus  @default(PENDING)
  reminderId       String?
  message          String?
  notes            String?
  executedByUserId String?
  executedAt       DateTime?
  createdAt        DateTime       @default(now())
  branch           Branch         @relation(fields: [branchId], references: [id])
  customer         Customer       @relation(fields: [customerId], references: [id])
  executedByUser   User?          @relation("ContactExecutedBy", fields: [executedByUserId], references: [id])
  reminder         Reminder?      @relation(fields: [reminderId], references: [id])

  @@index([customerId])
  @@index([branchId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Reminder {
  id                String            @id @default(cuid())
  branchId          String
  customerId        String
  type              ContactType
  status            ReminderStatus    @default(PENDING)
  scheduledFor      DateTime
  metadata          Json?
  dismissedAt       DateTime?
  dismissedByUserId String?
  dismissReason     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contacts          CustomerContact[]
  branch            Branch            @relation(fields: [branchId], references: [id])
  customer          Customer          @relation(fields: [customerId], references: [id])
  dismissedByUser   User?             @relation("ReminderDismissedBy", fields: [dismissedByUserId], references: [id])

  @@index([branchId])
  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([scheduledFor])
}

model SalesGoal {
  id          String       @id @default(cuid())
  branchId    String
  year        Int
  month       Int
  branchGoal  Decimal      @db.Decimal(12, 2)
  status      GoalStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  branch      Branch       @relation(fields: [branchId], references: [id])
  sellerGoals SellerGoal[]

  @@unique([branchId, year, month])
  @@index([branchId])
  @@index([year, month])
}

model SellerGoal {
  id          String    @id @default(cuid())
  salesGoalId String
  userId      String
  goalAmount  Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  salesGoal   SalesGoal @relation(fields: [salesGoalId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id])

  @@unique([salesGoalId, userId])
  @@index([userId])
}

model CommissionConfig {
  id                    String   @id @default(cuid())
  branchId              String   @unique
  baseCommissionPercent Decimal  @default(5) @db.Decimal(5, 2)
  goalBonusPercent      Decimal  @default(2) @db.Decimal(5, 2)
  categoryCommissions   Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  branch                Branch   @relation(fields: [branchId], references: [id])
}

model SellerCommission {
  id              String           @id @default(cuid())
  userId          String
  branchId        String
  year            Int
  month           Int
  totalSales      Decimal          @db.Decimal(12, 2)
  goalAmount      Decimal?         @db.Decimal(12, 2)
  goalAchieved    Boolean          @default(false)
  baseCommission  Decimal          @db.Decimal(10, 2)
  bonusCommission Decimal          @default(0) @db.Decimal(10, 2)
  totalCommission Decimal          @db.Decimal(10, 2)
  status          CommissionStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  branch          Branch           @relation(fields: [branchId], references: [id])
  user            User             @relation("SellerCommissions", fields: [userId], references: [id])

  @@unique([userId, branchId, year, month])
  @@index([userId])
  @@index([branchId])
  @@index([year, month])
}

enum UserRole {
  ADMIN
  GERENTE
  VENDEDOR
  CAIXA
  ATENDENTE
}

enum SaleStatus {
  OPEN
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentMethod {
  CASH
  PIX
  DEBIT_CARD
  CREDIT_CARD
  BOLETO
  STORE_CREDIT
  CHEQUE
  AGREEMENT
  OTHER
}

enum PaymentStatus {
  PENDING
  RECEIVED
  VOIDED
  REFUNDED
}

enum CashShiftStatus {
  OPEN
  CLOSED
}

enum CashMovementType {
  SALE_PAYMENT
  REFUND
  SUPPLY
  WITHDRAWAL
  ADJUSTMENT
  OPENING_FLOAT
  CLOSING
}

enum CashDirection {
  IN
  OUT
}

enum ProductType {
  FRAME
  CONTACT_LENS
  ACCESSORY
  SUNGLASSES
  LENS_SERVICE
  SERVICE
  OPHTHALMIC_LENS
  OPTICAL_ACCESSORY
  LENS_SOLUTION
  CASE
  CLEANING_KIT
  OTHER
}

enum StockReservationStatus {
  RESERVED
  RELEASED
  CONSUMED
}

enum ServiceOrderStatus {
  DRAFT
  APPROVED
  SENT_TO_LAB
  IN_PROGRESS
  READY
  DELIVERED
  CANCELED
}

enum ServiceOrderPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum WarrantyStatus {
  ACTIVE
  IN_ANALYSIS
  APPROVED
  DENIED
  EXPIRED
  USED
}

enum WarrantyType {
  FRAME
  LENS
  MOUNTING
  ADJUSTMENT
}

enum WarrantyClaimStatus {
  PENDING
  ANALYZING
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum FiscalStatus {
  NOT_REQUESTED
  PENDING
  AUTHORIZED
  FAILED
  CANCELED
}

enum QuoteStatus {
  DRAFT
  PENDING
  SENT
  APPROVED
  CONVERTED
  EXPIRED
  CANCELED
  LOST
}

enum QuoteItemType {
  PRODUCT
  SERVICE
  CUSTOM
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELED
}

enum AppointmentType {
  PICKUP
  ADJUSTMENT
  CONSULTATION
  RETURN
  EXAM
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELED
}

enum AgreementType {
  HEALTH_PLAN
  CORPORATE
  UNION
  ASSOCIATION
  PARTNERSHIP
}

enum StockMovementType {
  PURCHASE
  CUSTOMER_RETURN
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
  SALE
  LOSS
  SUPPLIER_RETURN
  INTERNAL_USE
  OTHER
}

enum CashbackMovementType {
  CREDIT
  DEBIT
  EXPIRED
  ADJUSTMENT
  BONUS
}

enum ContactType {
  PRESCRIPTION_REMINDER
  BIRTHDAY_GREETING
  INACTIVE_REACTIVATION
  CASHBACK_EXPIRING
  CASHBACK_AVAILABLE
  SALE_THANK_YOU
  ORDER_READY
  CUSTOM
}

enum ContactChannel {
  WHATSAPP
  PHONE
  EMAIL
  SMS
}

enum ContactStatus {
  PENDING
  SENT
  CONFIRMED
  SKIPPED
  FAILED
}

enum ReminderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DISMISSED
  EXPIRED
}

enum GoalStatus {
  ACTIVE
  CLOSED
  CANCELLED
}

enum LensType {
  SINGLE_VISION
  BIFOCAL
  MULTIFOCAL
  OCCUPATIONAL
}

enum AccountPayableStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

enum AccountReceivableStatus {
  PENDING
  RECEIVED
  OVERDUE
  CANCELED
}

enum AccountCategory {
  SUPPLIERS
  RENT
  UTILITIES
  PERSONNEL
  TAXES
  MARKETING
  MAINTENANCE
  EQUIPMENT
  OTHER
}

enum StockAdjustmentType {
  DAMAGE
  THEFT
  SUPPLIER_RETURN
  COUNT_ERROR
  FREE_SAMPLE
  EXPIRATION
  INTERNAL_USE
  OTHER
}

enum StockAdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
  AUTO_APPROVED
}

enum RuleCategory {
  STOCK
  SALES
  FINANCIAL
  PRODUCTS
  CUSTOMERS
  REPORTS
}

enum BarcodeType {
  EAN13
  CODE128
  QRCODE
}

// ============================================
// ENUMS - SAAS MULTI-TENANT
// ============================================

enum SubscriptionStatus {
  TRIAL
  TRIAL_EXPIRED
  ACTIVE
  PAST_DUE
  SUSPENDED
  CANCELED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELED
  REFUNDED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
  BILLING
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

// ============================================
// SAAS MULTI-TENANT - PLANOS
// ============================================

model Plan {
  id String @id @default(cuid())

  name        String
  slug        String  @unique
  description String?

  priceMonthly Int
  priceYearly  Int

  maxUsers     Int @default(3)
  maxBranches  Int @default(1)
  maxProducts  Int @default(500)
  maxStorageMB Int @default(1000)

  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)
  trialDays  Int     @default(14)
  sortOrder  Int     @default(0)

  stripeProductId      String?
  stripePriceMonthlyId String?
  stripePriceYearlyId  String?
  asaasPaymentLinkId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  features      PlanFeature[]
  subscriptions Subscription[]

  @@index([isActive, sortOrder])
}

model PlanFeature {
  id     String @id @default(cuid())
  planId String
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  key   String
  value String

  @@unique([planId, key])
  @@index([planId])
}

// ============================================
// SAAS MULTI-TENANT - ASSINATURAS
// ============================================

model Subscription {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  planId    String
  plan      Plan    @relation(fields: [planId], references: [id])

  status SubscriptionStatus @default(TRIAL)

  trialStartedAt     DateTime?
  trialEndsAt        DateTime?
  activatedAt        DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  canceledAt        DateTime?
  cancelReason      String?
  cancelAtPeriodEnd Boolean   @default(false)

  pastDueSince DateTime?

  billingCycle BillingCycle @default(MONTHLY)

  stripeCustomerId     String?
  stripeSubscriptionId String?
  asaasCustomerId      String?
  asaasSubscriptionId  String?

  discountPercent   Int?
  discountReason    String?
  discountExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]
  history  SubscriptionHistory[]

  @@index([companyId, status])
  @@index([status])
  @@index([currentPeriodEnd])
}

// ============================================
// SAAS MULTI-TENANT - FATURAS
// ============================================

model Invoice {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  number String @unique

  subtotal Int
  discount Int @default(0)
  total    Int

  status InvoiceStatus @default(PENDING)

  issuedAt DateTime  @default(now())
  dueDate  DateTime?
  paidAt   DateTime?

  periodStart DateTime
  periodEnd   DateTime

  paymentMethod  String?
  paymentGateway String?

  stripeInvoiceId String?
  asaasPaymentId  String?

  paymentUrl    String?
  pdfUrl        String?
  boletoUrl     String?
  boletoBarcode String?
  pixCode       String?
  pixQrCodeUrl  String?

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ========================================
  // COBRANÇA MANUAL - Campos de workflow
  // ========================================

  billingType String? // "PIX", "BOLETO", "CARTAO", "TRANSFERENCIA"

  // Checkboxes de controle
  invoiceGenerated   Boolean   @default(false) // Cobrança gerada
  invoiceGeneratedAt DateTime?
  invoiceGeneratedBy String? // adminId

  invoiceSent       Boolean   @default(false) // Boleto enviado ao cliente
  invoiceSentAt     DateTime?
  invoiceSentBy     String?
  invoiceSentMethod String? // "email", "whatsapp", "manual"

  paymentConfirmed   Boolean   @default(false) // Pagamento confirmado
  paymentConfirmedAt DateTime?
  paymentConfirmedBy String?
  paymentProofUrl    String? // Comprovante anexado

  nfGenerated   Boolean   @default(false) // Nota fiscal gerada
  nfGeneratedAt DateTime?
  nfGeneratedBy String?
  nfNumber      String? // Número da NF
  nfUrl         String? // Link/PDF da NF

  nfSent   Boolean   @default(false) // NF enviada ao cliente
  nfSentAt DateTime?
  nfSentBy String?

  // Observações
  adminNotes String? @db.Text // Notas internas sobre esta cobrança

  // Lembretes
  reminderSentAt DateTime? // Último lembrete enviado
  reminderCount  Int       @default(0) // Quantos lembretes já enviou

  @@index([subscriptionId, status])
  @@index([dueDate, status])
  @@index([number])
}

// ============================================
// SAAS MULTI-TENANT - BILLING EVENTS (WEBHOOKS)
// ============================================

model BillingEvent {
  id String @id @default(cuid())

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  gateway         String
  externalEventId String @unique
  eventType       String

  payload Json

  processedAt DateTime?
  error       String?
  retryCount  Int       @default(0)

  createdAt DateTime @default(now())

  @@index([gateway, eventType])
  @@index([companyId, createdAt])
  @@index([processedAt])
}

// ============================================
// SAAS MULTI-TENANT - DOMÍNIOS
// ============================================

model TenantDomain {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  subdomain    String? @unique
  customDomain String? @unique

  isPrimary  Boolean   @default(true)
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ============================================
// SAAS MULTI-TENANT - MÉTRICAS DE USO
// ============================================

model UsageMetric {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  periodStart DateTime
  periodEnd   DateTime

  usersCount      Int @default(0)
  branchesCount   Int @default(0)
  productsCount   Int @default(0)
  customersCount  Int @default(0)
  salesCount      Int @default(0)
  salesTotalCents Int @default(0)
  storageUsedMB   Int @default(0)
  apiCallsCount   Int @default(0)

  createdAt DateTime @default(now())

  @@unique([companyId, periodStart])
  @@index([companyId, periodStart])
}

// ============================================
// SAAS MULTI-TENANT - ADMIN USERS
// ============================================

model AdminUser {
  id String @id @default(cuid())

  email    String    @unique
  name     String
  password String
  role     AdminRole @default(SUPPORT)

  active      Boolean   @default(true)
  lastLoginAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  impersonations  ImpersonationSession[]
  assignedTickets SupportTicket[]
  auditLogs       GlobalAudit[]

  @@index([email])
  @@index([role, active])
}

// ============================================
// SAAS MULTI-TENANT - IMPERSONATION
// ============================================

model ImpersonationSession {
  id String @id @default(cuid())

  adminUserId String
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id])
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id])

  reason String

  ipAddress String?
  userAgent String?

  startedAt DateTime  @default(now())
  endedAt   DateTime?
  expiresAt DateTime

  @@index([companyId, startedAt])
  @@index([adminUserId, startedAt])
  @@index([expiresAt])
}

// ============================================
// SAAS MULTI-TENANT - AUDITORIA GLOBAL
// ============================================

model GlobalAudit {
  id String @id @default(cuid())

  actorType String
  actorId   String?
  adminUser AdminUser? @relation(fields: [actorId], references: [id])

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  action String

  metadata  Json?
  ipAddress String?

  createdAt DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([action, createdAt])
  @@index([actorId, createdAt])
}

// ============================================
// SAAS MULTI-TENANT - SUPORTE
// ============================================

model SupportTicket {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  number String @unique

  subject     String
  description String
  category    String

  priority TicketPriority @default(MEDIUM)
  status   TicketStatus   @default(OPEN)

  assignedToId String?
  assignedTo   AdminUser? @relation(fields: [assignedToId], references: [id])

  resolvedAt DateTime?
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages SupportMessage[]

  @@index([companyId, status])
  @@index([status, priority])
  @@index([assignedToId, status])
  @@index([number])
}

model SupportMessage {
  id String @id @default(cuid())

  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId   String
  authorType String
  authorName String

  message     String
  attachments String[]

  isInternal Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
}

// ============================================
// SAAS MULTI-TENANT - NOTAS DA EMPRESA (CRM)
// ============================================

model CompanyNote {
  id        String   @id @default(cuid())
  companyId String
  adminId   String
  adminName String // Desnormalizado para facilitar
  content   String   @db.Text
  type      String   @default("general") // general, commercial, support, billing
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([type])
  @@map("company_notes")
}

// ============================================
// SAAS MULTI-TENANT - HISTÓRICO DE ASSINATURA
// ============================================

model SubscriptionHistory {
  id             String   @id @default(cuid())
  subscriptionId String
  action         String // created, upgraded, downgraded, canceled, reactivated, extended_trial
  fromPlanId     String?
  toPlanId       String?
  fromStatus     String?
  toStatus       String?
  reason         String?
  adminId        String
  adminName      String
  metadata       Json? // Dados extras
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, createdAt])
  @@index([action])
  @@map("subscription_history")
}

// ============================================
// SAAS MULTI-TENANT - HEALTH SCORE
// ============================================

enum HealthCategory {
  CRITICAL // 0-40: Em risco crítico
  AT_RISK // 41-60: Precisa atenção
  HEALTHY // 61-80: Saudável
  THRIVING // 81-100: Excelente
}

model HealthScore {
  id        String         @id @default(cuid())
  companyId String
  score     Int // 0-100
  category  HealthCategory @default(HEALTHY)

  // Scores individuais (0-100 cada)
  usageScore      Int @default(50)
  billingScore    Int @default(50)
  engagementScore Int @default(50)
  supportScore    Int @default(50)

  // Análise e insights
  riskFactors   Json? // Array de strings: ["Sem login há 30 dias", "3 faturas atrasadas"]
  opportunities Json? // Array de strings: ["Upgrade para plano superior", "Ativar módulo X"]

  calculatedAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, calculatedAt])
  @@index([category])
  @@index([score])
  @@map("health_scores")
}

// ============================================
// SAAS MULTI-TENANT - SNAPSHOT DE USO
// ============================================

model UsageSnapshot {
  id        String   @id @default(cuid())
  companyId String
  date      DateTime @default(now())

  // Métricas de uso
  activeUsers    Int     @default(0)
  totalSales     Int     @default(0)
  totalRevenue   Decimal @default(0) @db.Decimal(10, 2)
  totalProducts  Int     @default(0)
  totalCustomers Int     @default(0)
  totalOrders    Int     @default(0)

  // Login activity
  lastLoginAt DateTime?
  loginCount  Int       @default(0)

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, date])
  @@map("usage_snapshots")
}

// ============================================
// SPRINT 8: REDE DE LOJAS (MULTI-FILIAL)
// ============================================

model Network {
  id String @id @default(cuid())

  name String // "Rede Visão Total"
  slug String @unique

  // Configurações de compartilhamento
  sharedCatalog   Boolean @default(true) // Produtos
  sharedPricing   Boolean @default(false) // Preços
  sharedSuppliers Boolean @default(true) // Fornecedores
  sharedCustomers Boolean @default(false) // Clientes (cross-sell)

  // Matriz (headquarters)
  headquartersId String?  @unique
  headquarters   Company? @relation("NetworkHeadquarters", fields: [headquartersId], references: [id])

  // Todas as empresas da rede
  companies Company[] @relation("NetworkCompanies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("networks")
}

// ============================================
// SPRINT 8: SISTEMA DE CONVITES
// ============================================

enum OnboardingStatus {
  PENDING_INVITE // Convite não enviado
  INVITE_SENT // Convite enviado, aguardando ativação
  INVITE_EXPIRED // Convite expirou
  ACTIVE // Usuário ativou a conta
}

enum InviteStatus {
  PENDING // Aguardando ativação
  ACTIVATED // Usuário ativou
  EXPIRED // Expirou
  REVOKED // Cancelado pelo admin
}

model Invite {
  id String @id @default(cuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Destinatário
  email String
  name  String
  role  String @default("admin") // admin, manager, operator

  // Token seguro
  token String @unique @default(cuid())

  // Validade
  expiresAt DateTime

  // Status
  status InviteStatus @default(PENDING)

  // Quem criou
  createdById   String
  createdByName String

  // Ativação
  activatedAt     DateTime?
  activatedUserId String?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([companyId])
  @@index([email])
  @@map("invites")
}

// ============================================
// SPRINT 8: FILA DE EMAILS
// ============================================

enum EmailStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

model EmailQueue {
  id String @id @default(cuid())

  to       String
  subject  String
  template String // "welcome", "invite", "password_reset"
  data     Json // Dados do template

  status EmailStatus @default(PENDING)

  attempts  Int     @default(0)
  lastError String?

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([status])
  @@map("email_queue")
}

// ============================================
// SPRINT 8: CONFIGURAÇÃO DE SLA
// ============================================

model SlaConfig {
  id String @id @default(cuid())

  priority TicketPriority @unique

  // Tempo em HORAS
  firstResponseHours Int // Prazo para primeira resposta
  resolutionHours    Int // Prazo para resolução

  // Notificações (% do prazo)
  notifyAtPercent Int[] @default([50, 75, 90])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sla_configs")
}

// ============================================
// CAMPANHAS DE PRODUTO - METAS E BONIFICAÇÕES
// ============================================

enum CampaignScope {
  SELLER // Bônus vai para o vendedor
  BRANCH // Bônus vai para a filial
  BOTH // Registra ambos
}

enum CampaignBonusType {
  PER_UNIT // Tipo A: R$ X por unidade vendida
  MINIMUM_FIXED // Tipo B1: Bônus fixo ao atingir mínimo
  MINIMUM_PER_UNIT // Tipo B2: Bônus por unidade a partir do mínimo
  PER_PACKAGE // Tipo C: Bônus a cada N unidades
  TIERED // Tipo D: Escalonado por faixas (futuro)
}

enum CampaignCountMode {
  BY_QUANTITY // Soma quantidades (padrão)
  BY_ITEM // Conta itens distintos
  BY_SALE // Conta vendas
}

enum CampaignStatus {
  DRAFT // Rascunho
  SCHEDULED // Agendada
  ACTIVE // Ativa
  PAUSED // Pausada
  ENDED // Encerrada
  CANCELED // Cancelada
}

enum MinimumCountMode {
  AFTER_MINIMUM // Conta somente ACIMA do mínimo
  FROM_MINIMUM // Conta A PARTIR do mínimo (inclui)
}

enum BonusEntryStatus {
  PENDING // Aguardando
  APPROVED // Aprovado
  PAID // Pago
  REVERSED // Revertido
  EXPIRED // Expirado
}

// ============================================
// MÓDULO DE CRM / FOLLOW-UP / LEMBRETES
// ============================================

enum CustomerSegment {
  BIRTHDAY // Aniversariantes do mês
  POST_SALE_30_DAYS // Pós-venda (até 30 dias)
  POST_SALE_90_DAYS // Pós-venda (30-90 dias)
  INACTIVE_6_MONTHS // 6 meses sem comprar
  INACTIVE_1_YEAR // 1 ano sem comprar
  INACTIVE_2_YEARS // 2 anos sem comprar
  INACTIVE_3_YEARS // 3+ anos sem comprar
  CASHBACK_EXPIRING // Cashback expirando
  PRESCRIPTION_EXPIRING // Receita vencendo (1 ano)
  VIP_CUSTOMER // Cliente VIP (alto valor)
  CONTACT_LENS_BUYER // Comprou lente de contato
  CUSTOM // Segmento personalizado
}

enum ContactResult {
  ANSWERED_SCHEDULED // Atendeu - Agendou visita
  ANSWERED_INTERESTED // Atendeu - Demonstrou interesse
  ANSWERED_NOT_INTERESTED // Atendeu - Sem interesse no momento
  NO_ANSWER // Não atendeu
  WRONG_NUMBER // Número errado/inválido
  DO_NOT_CONTACT // Pediu para não ligar mais
  CAME_BACK_PURCHASED // Voltou e comprou
  OTHER // Outro (ver observação)
}

enum CrmReminderStatus {
  PENDING // Aguardando contato
  IN_PROGRESS // Em andamento
  COMPLETED // Concluído
  SCHEDULED // Reagendado para outra data
  CANCELLED // Cancelado
}

model ProductCampaign {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  branchId  String? // Se null, vale para todas as filiais
  branch    Branch? @relation(fields: [branchId], references: [id])

  // Identificação
  name        String
  description String?
  code        String?

  // Período
  startDate DateTime
  endDate   DateTime

  // Escopo
  scope CampaignScope @default(SELLER)

  // Tipo de regra
  bonusType CampaignBonusType
  countMode CampaignCountMode @default(BY_QUANTITY)

  // Tipo A (PER_UNIT): valor por unidade
  bonusPerUnit Decimal? @db.Decimal(10, 2)

  // Tipo B (MINIMUM_*): configuração de mínimo
  minimumUnits      Int?
  minimumCountMode  MinimumCountMode @default(FROM_MINIMUM)
  bonusFixedOnMin   Decimal?         @db.Decimal(10, 2)
  bonusPerUnitAfter Decimal?         @db.Decimal(10, 2)

  // Tipo C (PER_PACKAGE): pacotes
  packageUnits       Int?
  bonusPerPackage    Decimal? @db.Decimal(10, 2)
  carryOverRemainder Boolean  @default(false)

  // Tipo D (TIERED): faixas escalonadas - NOVO!
  tiers Json? // Array de faixas: [{from: 10, to: 20, bonus: 5.00}, ...]

  // === LIMITES (NOVO!) ===
  maxBonusPerSeller Int? // Máximo por vendedor (centavos)
  maxBonusPerBranch Int? // Máximo por filial (centavos)
  maxBonusTotal     Int? // Máximo total da campanha (centavos)
  maxBonusPerDay    Int? // Máximo por dia (centavos)

  // === CONDIÇÕES EXTRAS (NOVO!) ===
  minSaleAmount     Int? // Venda mínima para valer (centavos)
  excludeDiscounted Boolean @default(false) // Excluir itens com desconto?
  onlyFullPrice     Boolean @default(false) // Apenas preço cheio?

  // === NOTIFICAÇÕES (NOVO!) ===
  notifyOnBonus   Boolean @default(false) // Notificar vendedor?
  notifyOnMinimum Boolean @default(false) // Notificar ao atingir mínimo?

  // Conflito entre campanhas
  priority      Int     @default(0)
  allowStacking Boolean @default(false)

  // Status elegíveis para processar
  eligibleSaleStatuses String[] @default(["COMPLETED"])

  // Status
  status CampaignStatus @default(DRAFT)

  // Controle de edição
  lockedAt DateTime?

  // Metadados
  createdByUserId String?
  createdBy       User?     @relation("CampaignCreatedBy", fields: [createdByUserId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relações
  products       ProductCampaignItem[]
  bonusEntries   CampaignBonusEntry[]
  sellerProgress CampaignSellerProgress[]

  @@index([companyId, status, startDate, endDate])
  @@index([branchId])
}

model ProductCampaignItem {
  id         String          @id @default(cuid())
  campaignId String
  campaign   ProductCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Pode vincular por produto OU por filtro
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  // OU filtros (se productId = null, usa filtros)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?    @relation(fields: [brandId], references: [id])
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // Multiplicador específico
  bonusMultiplier Decimal @default(1) @db.Decimal(5, 2)

  createdAt DateTime @default(now())

  @@index([campaignId])
  @@index([productId])
}

model CampaignBonusEntry {
  id         String          @id @default(cuid())
  companyId  String
  company    Company         @relation(fields: [companyId], references: [id])
  campaignId String
  campaign   ProductCampaign @relation(fields: [campaignId], references: [id])

  // Origem
  saleId     String
  sale       Sale      @relation(fields: [saleId], references: [id])
  saleItemId String?
  saleItem   SaleItem? @relation(fields: [saleItemId], references: [id])

  // Atribuição
  sellerUserId String?
  seller       User?   @relation("BonusSeller", fields: [sellerUserId], references: [id])
  branchId     String?
  branch       Branch? @relation(fields: [branchId], references: [id])

  // Valores
  quantity   Int
  totalBonus Decimal @db.Decimal(10, 2)
  multiplier Decimal @default(1) @db.Decimal(5, 2)

  // Detalhes do cálculo (para auditoria)
  calculationDetails Json?

  // Status
  status BonusEntryStatus @default(PENDING)

  // Datas
  earnedAt       DateTime  @default(now())
  processedAt    DateTime?
  reversedAt     DateTime?
  reversalReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // UNIQUE CONSTRAINT - IDEMPOTÊNCIA
  @@unique([campaignId, saleId, saleItemId])
  @@index([campaignId, status])
  @@index([saleId])
  @@index([sellerUserId, earnedAt])
}

model CampaignSellerProgress {
  id         String          @id @default(cuid())
  campaignId String
  campaign   ProductCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Por vendedor OU por filial
  sellerUserId String?
  seller       User?   @relation("CampaignProgress", fields: [sellerUserId], references: [id])
  branchId     String?
  branch       Branch? @relation(fields: [branchId], references: [id])

  // Contadores (atualizados INCREMENTALMENTE)
  totalQuantity Int     @default(0)
  totalSales    Int     @default(0)
  totalBonus    Decimal @default(0) @db.Decimal(10, 2)

  // Para tipo C (pacotes)
  carryOver Int @default(0)

  // Elegibilidade
  isEligible Boolean   @default(false)
  eligibleAt DateTime?

  lastCalculatedAt DateTime @default(now())

  @@unique([campaignId, sellerUserId])
  @@unique([campaignId, branchId])
}

// ============================================
// CRM: TEMPLATES DE MENSAGEM
// ============================================

model MessageTemplate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("MessageTemplates", fields: [companyId], references: [id], onDelete: Cascade)

  // Identificação
  name    String // Nome do template (ex: "Aniversário")
  segment CustomerSegment // Segmento associado

  // Conteúdo
  subject String? // Assunto (para email)
  message String  @db.Text // Mensagem (suporta variáveis)

  // Configuração
  isActive Boolean @default(true)
  channel  String  @default("whatsapp") // whatsapp, sms, email

  // Auditoria
  createdById String
  createdBy   User     @relation("TemplateCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, segment])
  @@index([companyId])
  @@map("message_templates")
}

// ============================================
// CRM: LEMBRETES DE CONTATO
// ============================================

model CustomerReminder {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CustomerReminders", fields: [companyId], references: [id], onDelete: Cascade)

  // Cliente
  customerId String
  customer   Customer @relation("CustomerReminders", fields: [customerId], references: [id], onDelete: Cascade)

  // Segmento e Prioridade
  segment  CustomerSegment
  priority Int             @default(0)

  // Dados calculados (snapshot)
  lastPurchaseDate      DateTime?
  lastPurchaseAmount    Decimal?  @db.Decimal(10, 2)
  lastPurchaseProduct   String?
  daysSinceLastPurchase Int?
  totalPurchases        Int       @default(0)
  totalSpent            Decimal   @default(0) @db.Decimal(10, 2)
  cashbackBalance       Decimal   @default(0) @db.Decimal(10, 2)

  // Status
  status       CrmReminderStatus @default(PENDING)
  scheduledFor DateTime?

  // Atribuição
  assignedToId String?
  assignedTo   User?   @relation("AssignedReminders", fields: [assignedToId], references: [id])

  // Auditoria
  generatedAt DateTime  @default(now())
  expiresAt   DateTime?

  // Relações
  contacts CrmContact[]

  @@index([companyId])
  @@index([customerId])
  @@index([segment])
  @@index([status])
  @@index([assignedToId])
  @@index([scheduledFor])
  @@map("customer_reminders")
}

// ============================================
// CRM: HISTÓRICO DE CONTATOS
// ============================================

model CrmContact {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("CrmContacts", fields: [companyId], references: [id], onDelete: Cascade)

  // Relacionamentos
  reminderId String?
  reminder   CustomerReminder? @relation(fields: [reminderId], references: [id], onDelete: SetNull)

  customerId String
  customer   Customer @relation("CrmContacts", fields: [customerId], references: [id], onDelete: Cascade)

  // Quem contatou
  contactedById String
  contactedBy   User   @relation("CrmContactsMade", fields: [contactedById], references: [id])

  // Detalhes do contato
  channel String // whatsapp, phone, sms, email, in_person
  segment CustomerSegment

  // Resultado
  result ContactResult
  notes  String?       @db.Text

  // Follow-up
  scheduleFollowUp Boolean   @default(false)
  followUpDate     DateTime?
  followUpNotes    String?

  // Se voltou a comprar
  resultedInSale Boolean  @default(false)
  saleId         String?
  saleAmount     Decimal? @db.Decimal(10, 2)

  // Timestamps
  contactedAt DateTime @default(now())

  @@index([companyId])
  @@index([customerId])
  @@index([contactedById])
  @@index([reminderId])
  @@index([contactedAt])
  @@index([result])
  @@map("crm_contacts")
}

// ============================================
// CRM: METAS DE CONTATO
// ============================================

model ContactGoal {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation("ContactGoals", fields: [companyId], references: [id], onDelete: Cascade)

  // Período
  period    String // daily, weekly, monthly
  startDate DateTime
  endDate   DateTime

  // Meta
  targetContacts Int

  // Atribuição (null = meta geral)
  userId String?
  user   User?   @relation("UserGoals", fields: [userId], references: [id])

  branchId String?
  branch   Branch? @relation("BranchContactGoals", fields: [branchId], references: [id])

  // Auditoria
  createdById String
  createdBy   User     @relation("GoalCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([branchId])
  @@index([startDate, endDate])
  @@map("contact_goals")
}

// ============================================
// CRM: CONFIGURAÇÕES
// ============================================

model CrmSettings {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation("CrmSettings", fields: [companyId], references: [id], onDelete: Cascade)

  // Critérios de segmentação (dias)
  postSaleDays1       Int @default(7)
  postSaleDays2       Int @default(30)
  postSaleDays3       Int @default(90)
  inactiveDays6Months Int @default(180)
  inactiveDays1Year   Int @default(365)
  inactiveDays2Years  Int @default(730)
  inactiveDays3Years  Int @default(1095)

  // VIP
  vipMinPurchases  Int     @default(5)
  vipMinTotalSpent Decimal @default(5000) @db.Decimal(10, 2)

  // Cashback
  cashbackExpiringDays Int @default(30)

  // Receita
  prescriptionValidityDays Int @default(365)
  prescriptionWarningDays  Int @default(30)

  // Lente de contato
  contactLensReorderDays Int @default(30)

  // Metas padrão
  defaultDailyGoal   Int @default(10)
  defaultWeeklyGoal  Int @default(50)
  defaultMonthlyGoal Int @default(200)

  // Geração automática
  autoGenerateReminders Boolean @default(true)
  generateOnDayOfWeek   Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crm_settings")
}

// ============================================================
// MÓDULO FINANCEIRO — ENUMS
// ============================================================

enum FinanceEntryType {
  SALE_REVENUE
  COGS
  PAYMENT_RECEIVED
  CARD_FEE
  COMMISSION_EXPENSE
  EXPENSE
  REFUND
  STOCK_ADJUST
  TRANSFER
  OTHER
}

enum FinanceEntrySide {
  DEBIT
  CREDIT
}

enum FinanceAccountType {
  CASH
  BANK
  PIX
  CARD_ACQUIRER
  OTHER
}

enum ChartAccountKind {
  ASSET
  LIABILITY
  REVENUE
  EXPENSE
  EQUITY
}

enum RefundStatus {
  PENDING
  APPROVED
  COMPLETED
  CANCELED
}

// ============================================================
// MÓDULO FINANCEIRO — MODELS
// ============================================================

model ChartOfAccounts {
  id        String           @id @default(cuid())
  companyId String
  company   Company          @relation(fields: [companyId], references: [id])

  code      String           // "1.1.01"
  name      String           // "Caixa"
  kind      ChartAccountKind // ASSET, LIABILITY, REVENUE, EXPENSE, EQUITY
  parentId  String?
  parent    ChartOfAccounts? @relation("ChartHierarchy", fields: [parentId], references: [id])
  children  ChartOfAccounts[] @relation("ChartHierarchy")
  isSystem  Boolean          @default(true) // Contas padrão não podem ser removidas
  active    Boolean          @default(true)

  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  debitEntries  FinanceEntry[] @relation("DebitAccount")
  creditEntries FinanceEntry[] @relation("CreditAccount")

  @@unique([companyId, code])
  @@index([companyId, kind])
  @@index([parentId])
}

model FinanceAccount {
  id        String             @id @default(cuid())
  companyId String
  company   Company            @relation(fields: [companyId], references: [id])
  branchId  String?
  branch    Branch?            @relation(fields: [branchId], references: [id])

  name      String             // "Caixa Principal", "PIX", "Conta Itaú"
  type      FinanceAccountType // CASH, BANK, PIX, CARD_ACQUIRER
  balance   Decimal            @default(0) @db.Decimal(14, 2)
  isDefault Boolean            @default(false)
  active    Boolean            @default(true)

  bankName          String?          // "Itaú", "Bradesco", "Nubank"
  agency            String?          // "1234"
  accountNumber     String?          // "56789-0"
  pixKey            String?          // Chave PIX
  acquirerName      String?          // "Stone", "Cielo", "Rede"
  defaultFeePercent Decimal?         @db.Decimal(5, 2) // Taxa padrão do adquirente
  description       String?          // Observações

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  financeEntries        FinanceEntry[]
  reconciliationBatches ReconciliationBatch[]

  @@unique([companyId, name])
  @@index([companyId, type])
  @@index([branchId])
}

model FinanceEntry {
  id        String           @id @default(cuid())
  companyId String
  company   Company          @relation(fields: [companyId], references: [id])
  branchId  String?
  branch    Branch?          @relation(fields: [branchId], references: [id])

  type      FinanceEntryType // SALE_REVENUE, COGS, PAYMENT_RECEIVED, etc.
  side      FinanceEntrySide // DEBIT ou CREDIT
  amount    Decimal          @db.Decimal(14, 2)

  debitAccountId  String?
  debitAccount    ChartOfAccounts? @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccountId String?
  creditAccount   ChartOfAccounts? @relation("CreditAccount", fields: [creditAccountId], references: [id])

  financeAccountId String?
  financeAccount   FinanceAccount? @relation(fields: [financeAccountId], references: [id])

  // Rastreabilidade — qual entidade originou este lançamento
  sourceType String?          // "Sale", "SalePayment", "Refund", "Expense"
  sourceId   String?

  description String?
  entryDate   DateTime         @default(now())
  cashDate    DateTime?        // Data do regime de caixa (quando dinheiro entra/sai)
  createdAt   DateTime         @default(now())

  @@unique([companyId, sourceType, sourceId, type, side])
  @@index([companyId, entryDate])
  @@index([companyId, cashDate])
  @@index([companyId, type])
  @@index([debitAccountId])
  @@index([creditAccountId])
  @@index([financeAccountId])
  @@index([sourceType, sourceId])
}

model InventoryLot {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  supplierId String?
  supplier   Supplier? @relation("LotSupplier", fields: [supplierId], references: [id])

  qtyIn        Int              // Quantidade de entrada
  qtyRemaining Int              // Quantidade restante (FIFO)
  unitCost     Decimal          @db.Decimal(12, 2)
  totalCost    Decimal          @db.Decimal(14, 2)

  invoiceNumber String?         // NF de entrada
  acquiredAt    DateTime        @default(now())
  createdAt     DateTime        @default(now())

  saleItemLots SaleItemLot[]

  @@index([companyId, productId, acquiredAt])
  @@index([productId, qtyRemaining])
  @@index([branchId])
}

model SaleItemLot {
  id            String       @id @default(cuid())
  saleItemId    String
  saleItem      SaleItem     @relation(fields: [saleItemId], references: [id])
  inventoryLotId String
  inventoryLot  InventoryLot @relation(fields: [inventoryLotId], references: [id])

  qtyConsumed Int
  unitCost    Decimal        @db.Decimal(12, 2)
  totalCost   Decimal        @db.Decimal(14, 2)

  createdAt   DateTime       @default(now())

  @@unique([saleItemId, inventoryLotId])
  @@index([inventoryLotId])
}

model Refund {
  id         String       @id @default(cuid())
  companyId  String
  company    Company      @relation(fields: [companyId], references: [id])
  branchId   String?
  branch     Branch?      @relation(fields: [branchId], references: [id])
  saleId     String
  sale       Sale         @relation(fields: [saleId], references: [id])
  customerId String?
  customer   Customer?    @relation(fields: [customerId], references: [id])

  status     RefundStatus @default(PENDING)
  reason     String?
  totalRefund Decimal     @db.Decimal(12, 2)
  totalCost   Decimal     @default(0) @db.Decimal(12, 2) // Custo dos itens devolvidos
  refundMethod String?    // "CASH", "CREDIT", "STORE_CREDIT"
  notes      String?

  approvedAt  DateTime?
  completedAt DateTime?
  canceledAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  items RefundItem[]

  @@index([companyId, createdAt])
  @@index([saleId])
  @@index([customerId])
  @@index([status])
}

model RefundItem {
  id          String   @id @default(cuid())
  refundId    String
  refund      Refund   @relation(fields: [refundId], references: [id])
  saleItemId  String
  saleItem    SaleItem @relation(fields: [saleItemId], references: [id])

  qtyReturned  Int
  refundAmount Decimal  @db.Decimal(12, 2)
  costAmount   Decimal  @default(0) @db.Decimal(12, 2) // Custo FIFO dos itens devolvidos

  createdAt    DateTime @default(now())

  @@index([refundId])
  @@index([saleItemId])
}

model DailyAgg {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  date      DateTime @db.Date

  // Métricas de vendas
  salesCount    Int     @default(0)
  grossRevenue  Decimal @default(0) @db.Decimal(14, 2)
  discountTotal Decimal @default(0) @db.Decimal(14, 2)
  netRevenue    Decimal @default(0) @db.Decimal(14, 2)
  cogs          Decimal @default(0) @db.Decimal(14, 2) // CMV
  grossMargin   Decimal @default(0) @db.Decimal(14, 2) // Margem bruta
  cardFees      Decimal @default(0) @db.Decimal(14, 2)
  commissions   Decimal @default(0) @db.Decimal(14, 2)
  netProfit     Decimal @default(0) @db.Decimal(14, 2) // Lucro líquido estimado
  avgTicket     Decimal @default(0) @db.Decimal(14, 2)
  itemsSold     Int     @default(0)

  // Totais por método de pagamento
  cashTotal       Decimal @default(0) @db.Decimal(14, 2)
  pixTotal        Decimal @default(0) @db.Decimal(14, 2)
  debitCardTotal  Decimal @default(0) @db.Decimal(14, 2)
  creditCardTotal Decimal @default(0) @db.Decimal(14, 2)
  boletoTotal     Decimal @default(0) @db.Decimal(14, 2)
  otherTotal      Decimal @default(0) @db.Decimal(14, 2)

  // Devoluções
  refundsCount  Int     @default(0)
  refundsTotal  Decimal @default(0) @db.Decimal(14, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, branchId, date])
  @@index([companyId, date])
  @@index([branchId, date])
}

// ============================================================
// CONCILIAÇÃO FINANCEIRA — ENUMS
// ============================================================

enum ReconciliationSource {
  CARD_ACQUIRER
  BANK_STATEMENT
  RECEIVABLES
  CASH_REGISTER
  PIX
  OTHER
}

enum ReconciliationBatchStatus {
  DRAFT
  IMPORTED
  MATCHING
  MATCHED
  REVIEWING
  CLOSED
  CANCELED
}

enum ReconciliationItemStatus {
  PENDING
  AUTO_MATCHED
  SUGGESTED_MATCH
  MANUAL_MATCHED
  UNMATCHED
  IGNORED
  DIVERGENT
  RESOLVED
  DISPUTED
}

enum ReconciliationItemDirection {
  CREDIT
  DEBIT
}

enum ReconciliationResolutionType {
  EXACT_MATCH
  ADJUSTED
  PARTIAL
  WRITTEN_OFF
  IGNORED
  FEE_ADJUSTMENT
  CHARGEBACK
  DUPLICATE
  MISSING_INTERNAL
  MISSING_EXTERNAL
}

// ============================================================
// CONCILIAÇÃO FINANCEIRA — MODELS
// ============================================================

model ReconciliationBatch {
  id        String                     @id @default(cuid())
  companyId String
  company   Company                    @relation(fields: [companyId], references: [id])
  branchId  String?
  branch    Branch?                    @relation(fields: [branchId], references: [id])

  financeAccountId String?
  financeAccount   FinanceAccount?     @relation(fields: [financeAccountId], references: [id])

  source       ReconciliationSource      // CARD_ACQUIRER, BANK_STATEMENT, PIX
  status       ReconciliationBatchStatus @default(DRAFT)
  acquirerName String?                   // "Stone", "Cielo", "Rede"
  periodStart  DateTime?
  periodEnd    DateTime?
  fileName     String?
  description  String?

  // Contadores
  totalItems    Int     @default(0)
  totalAmount   Decimal @default(0) @db.Decimal(14, 2)
  matchedCount  Int     @default(0)
  unmatchedCount Int    @default(0)
  divergentCount Int    @default(0)
  ignoredCount   Int    @default(0)

  importedAt DateTime?
  closedAt   DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  items ReconciliationItem[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@index([financeAccountId])
}

model ReconciliationItem {
  id      String              @id @default(cuid())
  batchId String
  batch   ReconciliationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Dados externos (do CSV/adquirente)
  externalDate   DateTime
  externalAmount Decimal            @db.Decimal(14, 2)
  externalId     String?            // NSU do adquirente
  externalRef    String?            // Código de autorização externo
  cardBrand      String?
  cardLastDigits String?
  installments   Int?
  direction      ReconciliationItemDirection @default(CREDIT)
  rawData        Json?              // Linha original do CSV

  // Match interno
  status              ReconciliationItemStatus @default(PENDING)
  matchedSalePaymentId String?
  matchedSalePayment   SalePayment?            @relation(fields: [matchedSalePaymentId], references: [id])
  matchedReceivableId  String?
  matchedReceivable    AccountReceivable?      @relation(fields: [matchedReceivableId], references: [id])

  internalAmount    Decimal?           @db.Decimal(14, 2) // Valor encontrado internamente
  differenceAmount  Decimal?           @db.Decimal(14, 2) // Diferença (externo - interno)
  matchConfidence   Int?               // 0-100 %
  resolutionType    ReconciliationResolutionType?
  resolutionNotes   String?
  resolvedAt        DateTime?
  resolvedByUserId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId, status])
  @@index([externalId])
  @@index([externalRef])
  @@index([matchedSalePaymentId])
  @@index([matchedReceivableId])
}

model ReconciliationTemplate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name          String        // "Stone Padrão", "Cielo CSV"
  acquirerName  String?       // "Stone", "Cielo", "Rede"
  isSystem      Boolean       @default(false) // Templates padrão
  columnMapping Json          // { nsu: 0, date: 1, amount: 2, brand: 3, ... }
  delimiter     String        @default(",")
  encoding      String        @default("utf-8")
  skipRows      Int           @default(1) // Pular header
  dateFormat    String        @default("dd/MM/yyyy")
  decimalSep    String        @default(",")

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@index([companyId, active])
}

model ReconciliationRule {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name           String
  description    String?
  matchCriteria  Json       // { fields: ["nsu", "amount"], tolerances: { amount: 0.01, dateDays: 2 } }
  autoApprove    Boolean    @default(false)
  priority       Int        @default(0) // Prioridade (menor = mais prioritário)

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, active, priority])
}
