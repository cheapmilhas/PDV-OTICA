generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Counter {
  id        String   @id @default(cuid())
  companyId String
  key       String
  value     Int      @default(0)
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId])
}

model Company {
  id                 String              @id @default(cuid())
  name               String
  tradeName          String?
  cnpj               String?             @unique
  address            String?
  city               String?
  state              String?
  zipCode            String?
  phone              String?
  email              String?
  website            String?
  logoPath           String?
  settings           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
  agreements         Agreement[]
  appointments       Appointment[]
  auditLogs          AuditLog[]
  branches           Branch[]
  brands             Brand[]
  cashShifts         CashShift[]
  categories         Category[]
  colors             Color[]
  commissions        Commission[]
  commissionRules    CommissionRule[]
  companySettings    CompanySettings?    @relation("CompanySettings")
  customers          Customer[]
  dreReports         DREReport[]
  doctors            Doctor[]
  labs               Lab[]
  lensTreatments     LensTreatment[]     @relation("CompanyLensTreatments")
  loyaltyPoints      LoyaltyPoints[]
  loyaltyProgram     LoyaltyProgram?
  prescriptions      Prescription[]
  products           Product[]
  quotes             Quote[]
  sales              Sale[]
  serviceOrders      ServiceOrder[]
  shapes             Shape[]
  stockAdjustments   StockAdjustment[]
  stockMovements     StockMovement[]
  stockReservations  StockReservation[]
  suppliers          Supplier[]
  systemRules        SystemRule[]
  users              User[]
  warranties         Warranty[]
  counters           Counter[]
}

model Branch {
  id                   String              @id @default(cuid())
  companyId            String
  name                 String
  code                 String?
  address              String?
  city                 String?
  state                String?
  zipCode              String?
  phone                String?
  stateRegistration    String?
  nfeSeries            Int?
  lastNfeNumber        Int?
  active               Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  accountsPayable      AccountPayable[]
  accountsReceivable   AccountReceivable[]
  appointments         Appointment[]
  auditLogs            AuditLog[]
  company              Company             @relation(fields: [companyId], references: [id])
  cashMovements        CashMovement[]
  shifts               CashShift[]
  cashbackConfig       CashbackConfig?
  commissionConfig     CommissionConfig?
  customerCashbacks    CustomerCashback[]
  customerContacts     CustomerContact[]
  dreReports           DREReport[]
  quotes               Quote[]
  reminders            Reminder[]
  reminderConfig       ReminderConfig?
  sales                Sale[]
  salesGoals           SalesGoal[]
  sellerCommissions    SellerCommission[]
  serviceOrders        ServiceOrder[]
  stockMovementsSource StockMovement[]     @relation("StockMovementSource")
  stockMovementsTarget StockMovement[]     @relation("StockMovementTarget")
  stockReservations    StockReservation[]
  userBranches         UserBranch[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model User {
  id                         String                @id @default(cuid())
  companyId                  String
  name                       String
  email                      String                @unique
  passwordHash               String
  role                       UserRole
  active                     Boolean               @default(true)
  defaultCommissionPercent   Decimal?              @db.Decimal(5, 2)
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  accountsPayableCreated     AccountPayable[]      @relation("AccountPayableCreator")
  accountsPayablePaid        AccountPayable[]      @relation("AccountPayablePayer")
  accountsReceivableCreated  AccountReceivable[]   @relation("AccountReceivableCreator")
  accountsReceivableReceived AccountReceivable[]   @relation("AccountReceivableReceiver")
  logs                       AuditLog[]
  cashMovementsCreated       CashMovement[]        @relation("CashMovementCreator")
  shiftsClosed               CashShift[]           @relation("ShiftCloser")
  shiftsOpened               CashShift[]           @relation("ShiftOpener")
  cashbackMovementsCreated   CashbackMovement[]    @relation("CashbackMovementCreatedBy")
  commissions                Commission[]
  contactsExecuted           CustomerContact[]     @relation("ContactExecutedBy")
  barcodesCreated            ProductBarcode[]      @relation("BarcodeCreator")
  qualityChecks              QualityChecklist[]    @relation("QualityChecker")
  quotesConverted            Quote[]               @relation("QuoteConverter")
  quotesAsSeller             Quote[]               @relation("QuoteSeller")
  remindersDismissed         Reminder[]            @relation("ReminderDismissedBy")
  salesAsSeller              Sale[]                @relation("SaleSeller")
  paymentsReceived           SalePayment[]         @relation("PaymentReceiver")
  sellerCommissions          SellerCommission[]    @relation("SellerCommissions")
  sellerGoals                SellerGoal[]
  serviceOrdersCreated       ServiceOrder[]        @relation("SOCreator")
  serviceOrdersDelivered     ServiceOrder[]        @relation("SODeliverer")
  soHistoryChanges           ServiceOrderHistory[] @relation("SOHistoryChanger")
  stockAdjustmentsApproved   StockAdjustment[]     @relation("AdjustmentApprover")
  stockAdjustmentsCreated    StockAdjustment[]     @relation("AdjustmentCreator")
  stockMovements             StockMovement[]
  company                    Company               @relation(fields: [companyId], references: [id])
  branches                   UserBranch[]
  customPermissions          UserPermission[]      @relation("UserCustomPermissions")

  @@index([companyId, role])
  @@index([companyId, name])
}

model UserBranch {
  userId   String
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@id([userId, branchId])
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  branchId   String?
  userId     String?
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  ip         String?
  createdAt  DateTime @default(now())
  branch     Branch?  @relation(fields: [branchId], references: [id])
  company    Company  @relation(fields: [companyId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([branchId, createdAt])
}

model Customer {
  id                 String                 @id @default(cuid())
  companyId          String
  name               String
  cpf                String?
  rg                 String?
  phone              String?
  phone2             String?
  email              String?
  birthDate          DateTime?
  gender             String?
  address            String?
  number             String?
  complement         String?
  neighborhood       String?
  city               String?
  state              String?
  zipCode            String?
  acceptsMarketing   Boolean                @default(true)
  referralSource     String?
  notes              String?
  active             Boolean                @default(true)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  accountsReceivable AccountReceivable[]
  agreementBenefits  AgreementBeneficiary[]
  appointments       Appointment[]
  company            Company                @relation(fields: [companyId], references: [id])
  cashback           CustomerCashback[]
  contacts           CustomerContact[]
  dependents         CustomerDependent[]
  loyaltyPoints      LoyaltyPoints[]
  prescriptions      Prescription[]
  quotes             Quote[]
  reminders          Reminder[]
  sales              Sale[]
  serviceOrders      ServiceOrder[]

  @@unique([companyId, cpf])
  @@index([companyId, name])
  @@index([companyId, phone])
  @@index([companyId, email])
}

model CustomerDependent {
  id           String    @id @default(cuid())
  customerId   String
  name         String
  relationship String
  birthDate    DateTime?
  cpf          String?
  createdAt    DateTime  @default(now())
  customer     Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Doctor {
  id                       String         @id @default(cuid())
  companyId                String
  name                     String
  crm                      String?
  uf                       String?
  specialty                String?
  isPartner                Boolean        @default(false)
  partnerCommissionPercent Decimal?       @db.Decimal(5, 2)
  phone                    String?
  email                    String?
  clinicName               String?
  clinicAddress            String?
  active                   Boolean        @default(true)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  company                  Company        @relation(fields: [companyId], references: [id])
  prescriptions            Prescription[]

  @@unique([companyId, crm, uf])
  @@index([companyId, name])
}

model Lab {
  id                  String              @id @default(cuid())
  companyId           String
  name                String
  code                String?
  cnpj                String?
  phone               String?
  email               String?
  orderEmail          String?
  website             String?
  contactPerson       String?
  integrationType     String?
  apiUrl              String?
  apiKey              String?
  clientCode          String?
  defaultLeadTimeDays Int                 @default(7)
  urgentLeadTimeDays  Int                 @default(3)
  paymentTermDays     Int                 @default(30)
  defaultDiscount     Decimal             @default(0) @db.Decimal(5, 2)
  qualityRating       Decimal?            @db.Decimal(3, 2)
  totalOrders         Int                 @default(0)
  totalReworks        Int                 @default(0)
  active              Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  company             Company             @relation(fields: [companyId], references: [id])
  priceRanges         LabPriceRange[]
  lensServices        LensServiceDetail[]
  serviceOrders       ServiceOrder[]
  serviceOrderItems   ServiceOrderItem[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model LensTreatment {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation("CompanyLensTreatments", fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId, active])
}

model LabPriceRange {
  id                String   @id @default(cuid())
  labId             String
  lensType          String
  material          String
  sphMin            Decimal? @db.Decimal(5, 2)
  sphMax            Decimal? @db.Decimal(5, 2)
  cylMin            Decimal? @db.Decimal(5, 2)
  cylMax            Decimal? @db.Decimal(5, 2)
  labPrice          Decimal  @db.Decimal(12, 2)
  suggestedPrice    Decimal? @db.Decimal(12, 2)
  arPrice           Decimal? @db.Decimal(12, 2)
  blueLightPrice    Decimal? @db.Decimal(12, 2)
  photochromicPrice Decimal? @db.Decimal(12, 2)
  leadTimeDays      Int?
  active            Boolean  @default(true)
  lab               Lab      @relation(fields: [labId], references: [id])

  @@index([labId, lensType, material])
}

model Supplier {
  id              String           @id @default(cuid())
  companyId       String
  name            String
  tradeName       String?
  cnpj            String?
  phone           String?
  email           String?
  website         String?
  contactPerson   String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  notes           String?
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  accountsPayable AccountPayable[]
  products        Product[]
  stockMovements  StockMovement[]
  company         Company          @relation(fields: [companyId], references: [id])

  @@unique([companyId, cnpj])
  @@index([companyId, name])
}

model Category {
  id                       String     @id @default(cuid())
  companyId                String
  name                     String
  parentId                 String?
  defaultCommissionPercent Decimal?   @db.Decimal(5, 2)
  minMarginPercent         Decimal?   @db.Decimal(5, 2)
  active                   Boolean    @default(true)
  company                  Company    @relation(fields: [companyId], references: [id])
  parent                   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children                 Category[] @relation("CategoryHierarchy")
  products                 Product[]

  @@unique([companyId, name])
}

model Brand {
  id           String    @id @default(cuid())
  companyId    String
  code         String
  name         String
  manufacturer String?
  minMargin    Decimal?  @db.Decimal(5, 2)
  maxDiscount  Decimal?  @db.Decimal(5, 2)
  segment      String?
  origin       String?
  logoPath     String?
  website      String?
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  company      Company   @relation(fields: [companyId], references: [id])
  products     Product[]

  @@unique([companyId, code])
  @@index([companyId, name])
}

model Shape {
  id          String    @id @default(cuid())
  companyId   String
  code        String
  name        String
  description String?
  imageUrl    String?
  faceTypes   String[]
  active      Boolean   @default(true)
  products    Product[]
  company     Company   @relation(fields: [companyId], references: [id])

  @@unique([companyId, code])
}

model Color {
  id        String    @id @default(cuid())
  companyId String
  code      String
  name      String
  hex       String?
  active    Boolean   @default(true)
  company   Company   @relation(fields: [companyId], references: [id])
  products  Product[]

  @@unique([companyId, code])
}

model Product {
  id                String             @id @default(cuid())
  companyId         String
  type              ProductType
  sku               String
  barcode           String?
  manufacturerCode  String?
  name              String
  description       String?
  categoryId        String?
  brandId           String?
  shapeId           String?
  colorId           String?
  costPrice         Decimal            @default(0) @db.Decimal(12, 2)
  salePrice         Decimal            @db.Decimal(12, 2)
  promoPrice        Decimal?           @db.Decimal(12, 2)
  marginPercent     Decimal?           @db.Decimal(5, 2)
  stockControlled   Boolean            @default(true)
  stockQty          Int                @default(0)
  stockMin          Int                @default(0)
  stockMax          Int?
  reorderPoint      Int?
  abcClass          String?
  turnoverDays      Int?
  ncm               String?
  cest              String?
  mainImage         String?
  images            String[]
  active            Boolean            @default(true)
  featured          Boolean            @default(false)
  launch            Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  supplierId        String?
  accessoryDetail   AccessoryDetail?
  contactLensDetail ContactLensDetail?
  frameDetail       FrameDetail?
  lensServiceDetail LensServiceDetail?
  brand             Brand?             @relation(fields: [brandId], references: [id])
  category          Category?          @relation(fields: [categoryId], references: [id])
  color             Color?             @relation(fields: [colorId], references: [id])
  company           Company            @relation(fields: [companyId], references: [id])
  shape             Shape?             @relation(fields: [shapeId], references: [id])
  supplier          Supplier?          @relation(fields: [supplierId], references: [id])
  barcodes          ProductBarcode[]
  quoteItems        QuoteItem[]
  saleItems         SaleItem[]
  serviceDetail     ServiceDetail?
  serviceOrderItems ServiceOrderItem[]
  stockAdjustments  StockAdjustment[]
  stockMovements    StockMovement[]
  stockReservations StockReservation[]

  @@unique([companyId, sku])
  @@index([companyId, name])
  @@index([companyId, barcode])
  @@index([companyId, type])
  @@index([companyId, abcClass])
}

model FrameDetail {
  productId   String  @id
  lensWidthMm Int?
  bridgeMm    Int?
  templeMm    Int?
  sizeText    String?
  material    String?
  gender      String?
  collection  String?
  product     Product @relation(fields: [productId], references: [id])
}

model ContactLensDetail {
  productId  String  @id
  brandModel String?
  type       String?
  material   String?
  baseCurve  String?
  diameter   String?
  packQty    Int?
  sphRange   String?
  cylRange   String?
  axisRange  String?
  addRange   String?
  color      String?
  product    Product @relation(fields: [productId], references: [id])
}

model AccessoryDetail {
  productId String  @id
  subtype   String?
  product   Product @relation(fields: [productId], references: [id])
}

model ServiceDetail {
  productId   String  @id
  serviceType String?
  durationMin Int?
  product     Product @relation(fields: [productId], references: [id])
}

model LensServiceDetail {
  productId       String   @id
  labId           String?
  lensType        String?
  material        String?
  refractionIndex Decimal? @db.Decimal(5, 2)
  treatments      Json?
  leadTimeDays    Int?
  lab             Lab?     @relation(fields: [labId], references: [id])
  product         Product  @relation(fields: [productId], references: [id])
}

model Prescription {
  id               String              @id @default(cuid())
  companyId        String
  customerId       String
  doctorId         String?
  issuedAt         DateTime
  expiresAt        DateTime
  prescriptionType String?
  notes            String?
  imageUrl         String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  company          Company             @relation(fields: [companyId], references: [id])
  customer         Customer            @relation(fields: [customerId], references: [id])
  doctor           Doctor?             @relation(fields: [doctorId], references: [id])
  values           PrescriptionValues?
  serviceOrders    ServiceOrder[]      @relation("SOPrescription")

  @@index([companyId, customerId])
  @@index([customerId, expiresAt])
}

model PrescriptionValues {
  id               String       @id @default(cuid())
  prescriptionId   String       @unique
  odSph            Decimal?     @db.Decimal(6, 2)
  odCyl            Decimal?     @db.Decimal(6, 2)
  odAxis           Int?
  odAdd            Decimal?     @db.Decimal(6, 2)
  odPrism          Decimal?     @db.Decimal(6, 2)
  odBase           String?
  oeSph            Decimal?     @db.Decimal(6, 2)
  oeCyl            Decimal?     @db.Decimal(6, 2)
  oeAxis           Int?
  oeAdd            Decimal?     @db.Decimal(6, 2)
  oePrism          Decimal?     @db.Decimal(6, 2)
  oeBase           String?
  pdFar            Decimal?     @db.Decimal(5, 2)
  pdNear           Decimal?     @db.Decimal(5, 2)
  fittingHeightOd  Decimal?     @db.Decimal(5, 2)
  fittingHeightOe  Decimal?     @db.Decimal(5, 2)
  pantoscopicAngle Decimal?     @db.Decimal(5, 2)
  vertexDistance   Decimal?     @db.Decimal(5, 2)
  frameCurvature   Decimal?     @db.Decimal(5, 2)
  prescription     Prescription @relation(fields: [prescriptionId], references: [id])
}

model ServiceOrder {
  id               String                @id @default(cuid())
  number           Int                   @default(0) // Número sequencial por empresa (gerado no service)
  companyId        String
  branchId         String
  customerId       String
  prescriptionId   String?
  createdByUserId  String

  // === STATUS E PRIORIDADE ===
  status           ServiceOrderStatus    @default(DRAFT)
  priority         ServiceOrderPriority  @default(NORMAL)

  // === DATAS DO FLUXO ===
  promisedDate     DateTime?             // Prazo prometido ao cliente
  labExpectedDate  DateTime?             // Prazo interno do laboratório
  sentToLabAt      DateTime?             // Quando foi enviada ao lab
  readyAt          DateTime?             // Quando ficou pronta
  deliveredAt      DateTime?             // Quando foi entregue ao cliente
  canceledAt       DateTime?             // Quando foi cancelada

  // === LABORATÓRIO ===
  laboratoryId     String?
  labOrderNumber   String?               // Número do pedido no laboratório
  labNotes         String?               // Observações para o lab

  // === ATRASO ===
  isDelayed        Boolean               @default(false)
  delayDays        Int?
  delayReason      String?

  // === GARANTIA / RETRABALHO ===
  isWarranty       Boolean               @default(false)
  isRework         Boolean               @default(false)
  warrantyReason   String?
  reworkReason     String?
  originalOrderId  String?
  originalOrder    ServiceOrder?         @relation("OrderRework", fields: [originalOrderId], references: [id])
  reworkOrders     ServiceOrder[]        @relation("OrderRework")

  // === ENTREGA ===
  deliveredByUserId String?
  deliveryNotes     String?

  // === QUALIDADE ===
  qualityRating    Int?                  // 1-5 estrelas
  qualityNotes     String?

  // === DADOS ===
  prescriptionData Json?
  notes            String?

  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  // === RELAÇÕES ===
  company          Company               @relation(fields: [companyId], references: [id])
  branch           Branch                @relation(fields: [branchId], references: [id])
  customer         Customer              @relation(fields: [customerId], references: [id])
  prescriptionRel  Prescription?         @relation("SOPrescription", fields: [prescriptionId], references: [id])
  laboratory       Lab?                  @relation(fields: [laboratoryId], references: [id])
  createdByUser    User                  @relation("SOCreator", fields: [createdByUserId], references: [id])
  deliveredByUser  User?                 @relation("SODeliverer", fields: [deliveredByUserId], references: [id])
  qualityChecklist QualityChecklist?
  sale             Sale?
  items            ServiceOrderItem[]
  history          ServiceOrderHistory[]
  reservations     StockReservation[]
  warranties       Warranty[]

  @@unique([companyId, number])
  @@index([companyId, status])
  @@index([companyId, customerId])
  @@index([companyId, isDelayed])
  @@index([companyId, promisedDate])
  @@index([laboratoryId])
}

model ServiceOrderItem {
  id                   String       @id @default(cuid())
  serviceOrderId       String
  productId            String?
  labId                String?
  description          String?
  qty                  Int          @default(1)
  unitPrice            Decimal      @db.Decimal(12, 2)
  discount             Decimal      @default(0) @db.Decimal(12, 2)
  lineTotal            Decimal      @db.Decimal(12, 2)
  costEstimated        Decimal?     @db.Decimal(12, 2)
  measurementsSnapshot Json?
  createdAt            DateTime     @default(now())
  lab                  Lab?         @relation(fields: [labId], references: [id])
  product              Product?     @relation(fields: [productId], references: [id])
  serviceOrder         ServiceOrder @relation(fields: [serviceOrderId], references: [id])
  warranties           Warranty[]
}

model ServiceOrderHistory {
  id              String              @id @default(cuid())
  serviceOrderId  String
  action          String              // STATUS_CHANGED, REVERTED, EDITED, DELIVERED, CREATED, CANCELED
  fromStatus      ServiceOrderStatus?
  toStatus        ServiceOrderStatus?
  note            String?
  metadata        Json?               // Dados extras para auditoria
  changedByUserId String?
  createdAt       DateTime            @default(now())
  changedByUser   User?               @relation("SOHistoryChanger", fields: [changedByUserId], references: [id])
  serviceOrder    ServiceOrder        @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId, createdAt])
}

model QualityChecklist {
  id                String       @id @default(cuid())
  serviceOrderId    String       @unique
  lensGradeOk       Boolean      @default(false)
  lensCenteringOk   Boolean      @default(false)
  lensHeightOk      Boolean      @default(false)
  treatmentsOk      Boolean      @default(false)
  frameAdjustmentOk Boolean      @default(false)
  cleaningOk        Boolean      @default(false)
  notes             String?
  checkedByUserId   String?
  checkedAt         DateTime?
  customerApproved  Boolean      @default(false)
  checkedByUser     User?        @relation("QualityChecker", fields: [checkedByUserId], references: [id])
  serviceOrder      ServiceOrder @relation(fields: [serviceOrderId], references: [id])
}

model StockReservation {
  id             String                 @id @default(cuid())
  companyId      String
  branchId       String
  productId      String
  serviceOrderId String?
  saleId         String?
  qty            Int
  status         StockReservationStatus @default(RESERVED)
  createdAt      DateTime               @default(now())
  releasedAt     DateTime?
  consumedAt     DateTime?
  branch         Branch                 @relation(fields: [branchId], references: [id])
  company        Company                @relation(fields: [companyId], references: [id])
  product        Product                @relation(fields: [productId], references: [id])
  sale           Sale?                  @relation(fields: [saleId], references: [id])
  serviceOrder   ServiceOrder?          @relation(fields: [serviceOrderId], references: [id])

  @@index([branchId, productId, status])
  @@index([serviceOrderId])
  @@index([saleId])
}

model StockMovement {
  id              String            @id @default(cuid())
  companyId       String
  productId       String
  type            StockMovementType
  quantity        Int
  supplierId      String?
  invoiceNumber   String?
  sourceBranchId  String?
  targetBranchId  String?
  reason          String?
  notes           String?
  createdByUserId String?
  createdAt       DateTime          @default(now())
  company         Company           @relation(fields: [companyId], references: [id])
  createdBy       User?             @relation(fields: [createdByUserId], references: [id])
  product         Product           @relation(fields: [productId], references: [id])
  sourceBranch    Branch?           @relation("StockMovementSource", fields: [sourceBranchId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  targetBranch    Branch?           @relation("StockMovementTarget", fields: [targetBranchId], references: [id])

  @@index([companyId, productId, createdAt])
  @@index([companyId, type, createdAt])
  @@index([productId, createdAt])
  @@index([supplierId, createdAt])
}

model Quote {
  id                String      @id @default(cuid())
  companyId         String
  branchId          String
  customerId        String?
  sellerUserId      String
  status            QuoteStatus @default(PENDING)
  validUntil        DateTime?
  notes             String?
  subtotal          Decimal     @default(0) @db.Decimal(12, 2)
  discountTotal     Decimal     @default(0) @db.Decimal(12, 2)
  total             Decimal     @default(0) @db.Decimal(12, 2)
  lastFollowUpAt    DateTime?
  followUpCount     Int         @default(0)
  conversionReason  String?
  convertedToSaleId String?     @unique
  convertedToOsId   String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  convertedAt       DateTime?
  convertedByUserId String?
  customerEmail     String?
  customerName      String?
  customerPhone     String?
  discountPercent   Decimal     @default(0) @db.Decimal(5, 2)
  internalNotes     String?
  lostReason        String?
  paymentConditions String?
  contactCount      Int         @default(0)
  followUpDate      DateTime?
  followUpNotes     String?
  lastContactAt     DateTime?
  sentAt            DateTime?
  sentVia           String?
  branch            Branch      @relation(fields: [branchId], references: [id])
  company           Company     @relation(fields: [companyId], references: [id])
  convertedBy       User?       @relation("QuoteConverter", fields: [convertedByUserId], references: [id])
  customer          Customer?   @relation(fields: [customerId], references: [id])
  sellerUser        User        @relation("QuoteSeller", fields: [sellerUserId], references: [id])
  items             QuoteItem[]
  convertedToSale   Sale?       @relation("QuoteToSale")

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@index([customerId])
  @@index([validUntil])
  @@index([sellerUserId])
  @@index([branchId, status, createdAt])
  @@index([status, validUntil])
}

model QuoteItem {
  id               String        @id @default(cuid())
  quoteId          String
  productId        String?
  description      String
  qty              Int           @default(1)
  unitPrice        Decimal       @db.Decimal(12, 2)
  discount         Decimal       @default(0) @db.Decimal(12, 2)
  createdAt        DateTime      @default(now())
  itemType         QuoteItemType @default(PRODUCT)
  notes            String?
  prescriptionData Json?
  total            Decimal       @db.Decimal(12, 2)
  product          Product?      @relation(fields: [productId], references: [id])
  quote            Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Sale {
  id                   String              @id @default(cuid())
  companyId            String
  branchId             String
  customerId           String?
  serviceOrderId       String?             @unique
  sellerUserId         String
  status               SaleStatus          @default(OPEN)
  subtotal             Decimal             @default(0) @db.Decimal(12, 2)
  discountTotal        Decimal             @default(0) @db.Decimal(12, 2)
  total                Decimal             @default(0) @db.Decimal(12, 2)
  agreementId          String?
  agreementDiscount    Decimal?            @db.Decimal(12, 2)
  authorizationCode    String?
  fiscalStatus         FiscalStatus        @default(NOT_REQUESTED)
  fiscalModel          String?
  fiscalKey            String?
  fiscalXmlUrl         String?
  fiscalPdfUrl         String?
  completedAt          DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  convertedFromQuoteId String?             @unique
  cashbackUsed         Decimal             @default(0) @db.Decimal(10, 2)
  accountsReceivable   AccountReceivable[]
  cashbackMovements    CashbackMovement[]
  commissions          Commission[]
  agreement            Agreement?          @relation(fields: [agreementId], references: [id])
  branch               Branch              @relation(fields: [branchId], references: [id])
  company              Company             @relation(fields: [companyId], references: [id])
  convertedFromQuote   Quote?              @relation("QuoteToSale", fields: [convertedFromQuoteId], references: [id])
  customer             Customer?           @relation(fields: [customerId], references: [id])
  sellerUser           User                @relation("SaleSeller", fields: [sellerUserId], references: [id])
  serviceOrder         ServiceOrder?       @relation(fields: [serviceOrderId], references: [id])
  items                SaleItem[]
  payments             SalePayment[]
  reservations         StockReservation[]
  warranties           Warranty[]

  @@index([companyId, branchId, createdAt])
  @@index([customerId, createdAt])
  @@index([sellerUserId, createdAt])
  @@index([agreementId])
}

model SaleItem {
  id               String     @id @default(cuid())
  saleId           String
  productId        String?
  description      String?
  qty              Int        @default(1)
  unitPrice        Decimal    @db.Decimal(12, 2)
  discount         Decimal    @default(0) @db.Decimal(12, 2)
  lineTotal        Decimal    @db.Decimal(12, 2)
  costPrice        Decimal    @default(0) @db.Decimal(12, 2)
  stockControlled  Boolean    @default(true)
  stockQtyConsumed Int        @default(0)
  createdAt        DateTime   @default(now())
  product          Product?   @relation(fields: [productId], references: [id])
  sale             Sale       @relation(fields: [saleId], references: [id])
  warranties       Warranty[]

  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id               String         @id @default(cuid())
  saleId           String
  method           PaymentMethod
  status           PaymentStatus  @default(PENDING)
  amount           Decimal        @db.Decimal(12, 2)
  installments     Int?
  cardBrand        String?
  reference        String?
  details          Json?
  receivedAt       DateTime?
  receivedByUserId String?
  createdAt        DateTime       @default(now())
  cashMovements    CashMovement[]
  receivedByUser   User?          @relation("PaymentReceiver", fields: [receivedByUserId], references: [id])
  sale             Sale           @relation(fields: [saleId], references: [id])

  @@index([saleId, status])
  @@index([method, status])
}

model CommissionRule {
  id               String   @id @default(cuid())
  companyId        String
  name             String
  userId           String?
  categoryId       String?
  brandId          String?
  percentage       Decimal  @db.Decimal(5, 2)
  minMarginPercent Decimal? @db.Decimal(5, 2)
  priority         Int      @default(0)
  active           Boolean  @default(true)
  company          Company  @relation(fields: [companyId], references: [id])

  @@index([companyId, active])
}

model Commission {
  id               String           @id @default(cuid())
  companyId        String
  saleId           String
  userId           String
  baseAmount       Decimal          @db.Decimal(12, 2)
  percentage       Decimal          @db.Decimal(5, 2)
  commissionAmount Decimal          @db.Decimal(12, 2)
  status           CommissionStatus @default(PENDING)
  periodMonth      Int
  periodYear       Int
  approvedAt       DateTime?
  approvedByUserId String?
  paidAt           DateTime?
  paidByUserId     String?
  paymentMethod    String?
  paymentReference String?
  notes            String?
  createdAt        DateTime         @default(now())
  company          Company          @relation(fields: [companyId], references: [id])
  sale             Sale             @relation(fields: [saleId], references: [id])
  user             User             @relation(fields: [userId], references: [id])

  @@index([companyId, periodYear, periodMonth])
  @@index([userId, status])
  @@index([saleId])
}

model CashShift {
  id                      String          @id @default(cuid())
  companyId               String
  branchId                String
  status                  CashShiftStatus @default(OPEN)
  openedByUserId          String
  openedAt                DateTime        @default(now())
  openingFloatAmount      Decimal         @default(0) @db.Decimal(12, 2)
  closedByUserId          String?
  closedAt                DateTime?
  closingDeclaredCash     Decimal?        @db.Decimal(12, 2)
  closingExpectedCash     Decimal?        @db.Decimal(12, 2)
  differenceCash          Decimal?        @db.Decimal(12, 2)
  differenceJustification String?
  notes                   String?
  movements               CashMovement[]
  branch                  Branch          @relation(fields: [branchId], references: [id])
  closedByUser            User?           @relation("ShiftCloser", fields: [closedByUserId], references: [id])
  company                 Company         @relation(fields: [companyId], references: [id])
  openedByUser            User            @relation("ShiftOpener", fields: [openedByUserId], references: [id])

  @@index([branchId, status])
  @@index([companyId, openedAt])
}

model CashMovement {
  id              String           @id @default(cuid())
  cashShiftId     String
  branchId        String
  type            CashMovementType
  direction       CashDirection
  method          PaymentMethod
  amount          Decimal          @db.Decimal(12, 2)
  originType      String
  originId        String
  salePaymentId   String?
  createdByUserId String?
  note            String?
  createdAt       DateTime         @default(now())
  migrated        Boolean          @default(false)
  branch          Branch           @relation(fields: [branchId], references: [id])
  cashShift       CashShift        @relation(fields: [cashShiftId], references: [id])
  createdByUser   User?            @relation("CashMovementCreator", fields: [createdByUserId], references: [id])
  salePayment     SalePayment?     @relation(fields: [salePaymentId], references: [id])

  @@index([cashShiftId, createdAt])
  @@index([originType, originId])
  @@index([method, type])
}

model Warranty {
  id                 String            @id @default(cuid())
  companyId          String
  saleId             String?
  saleItemId         String?
  serviceOrderId     String?
  serviceOrderItemId String?
  warrantyType       WarrantyType
  status             WarrantyStatus    @default(ACTIVE)
  startAt            DateTime
  expiresAt          DateTime
  termsDescription   String?
  notes              String?
  company            Company           @relation(fields: [companyId], references: [id])
  sale               Sale?             @relation(fields: [saleId], references: [id])
  saleItem           SaleItem?         @relation(fields: [saleItemId], references: [id])
  serviceOrder       ServiceOrder?     @relation(fields: [serviceOrderId], references: [id])
  serviceOrderItem   ServiceOrderItem? @relation(fields: [serviceOrderItemId], references: [id])
  claims             WarrantyClaim[]

  @@index([companyId, status, expiresAt])
  @@index([saleId])
  @@index([serviceOrderId])
}

model WarrantyClaim {
  id                 String    @id @default(cuid())
  warrantyId         String
  openedAt           DateTime  @default(now())
  reason             String
  problemDescription String?
  resolution         String?
  resolutionType     String?
  filesUrl           String[]
  analyzedByUserId   String?
  analyzedAt         DateTime?
  closedAt           DateTime?
  closedByUserId     String?
  notes              String?
  warranty           Warranty  @relation(fields: [warrantyId], references: [id])

  @@index([warrantyId])
}

model Appointment {
  id                 String            @id @default(cuid())
  companyId          String
  branchId           String
  customerId         String?
  contactName        String?
  contactPhone       String?
  type               AppointmentType
  status             AppointmentStatus @default(SCHEDULED)
  scheduledAt        DateTime
  scheduledEndAt     DateTime?
  durationMinutes    Int               @default(30)
  serviceOrderId     String?
  assignedUserId     String?
  confirmed          Boolean           @default(false)
  confirmedAt        DateTime?
  confirmationMethod String?
  reminderSent       Boolean           @default(false)
  reminderSentAt     DateTime?
  checkinAt          DateTime?
  checkoutAt         DateTime?
  attendedByUserId   String?
  notes              String?
  internalNotes      String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  branch             Branch            @relation(fields: [branchId], references: [id])
  company            Company           @relation(fields: [companyId], references: [id])
  customer           Customer?         @relation(fields: [customerId], references: [id])

  @@index([branchId, scheduledAt])
  @@index([customerId, scheduledAt])
  @@index([status, scheduledAt])
}

model Agreement {
  id                String                 @id @default(cuid())
  companyId         String
  code              String
  name              String
  type              AgreementType
  cnpj              String?
  phone             String?
  email             String?
  contactPerson     String?
  discountPercent   Decimal                @default(0) @db.Decimal(5, 2)
  paymentTermDays   Int                    @default(30)
  billingDay        Int?
  minPurchase       Decimal?               @db.Decimal(12, 2)
  maxPurchase       Decimal?               @db.Decimal(12, 2)
  monthlyLimit      Decimal?               @db.Decimal(12, 2)
  contractPath      String?
  contractStartDate DateTime?
  contractEndDate   DateTime?
  notes             String?
  active            Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  company           Company                @relation(fields: [companyId], references: [id])
  beneficiaries     AgreementBeneficiary[]
  sales             Sale[]

  @@unique([companyId, code])
  @@index([companyId, active])
}

model AgreementBeneficiary {
  id               String    @id @default(cuid())
  agreementId      String
  customerId       String
  enrollmentNumber String?
  isHolder         Boolean   @default(true)
  holderId         String?
  enrolledAt       DateTime  @default(now())
  validUntil       DateTime?
  active           Boolean   @default(true)
  agreement        Agreement @relation(fields: [agreementId], references: [id])
  customer         Customer  @relation(fields: [customerId], references: [id])

  @@unique([agreementId, customerId])
  @@index([customerId])
}

model LoyaltyProgram {
  id                 String        @id @default(cuid())
  companyId          String        @unique
  name               String
  description        String?
  pointsPerReal      Decimal       @default(1) @db.Decimal(5, 2)
  reaisPerPoint      Decimal       @default(10) @db.Decimal(5, 2)
  pointsExpire       Boolean       @default(true)
  expirationDays     Int           @default(365)
  minRedemption      Int           @default(100)
  birthdayMultiplier Decimal       @default(2) @db.Decimal(3, 2)
  active             Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  company            Company       @relation(fields: [companyId], references: [id])
  tiers              LoyaltyTier[]
}

model LoyaltyTier {
  id               String         @id @default(cuid())
  programId        String
  name             String
  minPoints        Int
  discountPercent  Decimal        @default(0) @db.Decimal(5, 2)
  pointsMultiplier Decimal        @default(1) @db.Decimal(3, 2)
  priorityService  Boolean        @default(false)
  exclusiveGifts   Boolean        @default(false)
  badgeColor       String?
  icon             String?
  sortOrder        Int
  active           Boolean        @default(true)
  program          LoyaltyProgram @relation(fields: [programId], references: [id])
}

model LoyaltyPoints {
  id          String    @id @default(cuid())
  companyId   String
  customerId  String
  points      Int
  type        String
  saleId      String?
  description String?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id])
  customer    Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId, createdAt])
  @@index([companyId, expiresAt])
}

model DREReport {
  id                     String   @id @default(cuid())
  companyId              String
  branchId               String?
  periodMonth            Int
  periodYear             Int
  generatedAt            DateTime @default(now())
  generatedByUserId      String?
  grossRevenue           Decimal  @default(0) @db.Decimal(14, 2)
  returns                Decimal  @default(0) @db.Decimal(14, 2)
  discounts              Decimal  @default(0) @db.Decimal(14, 2)
  netRevenue             Decimal  @default(0) @db.Decimal(14, 2)
  costOfGoodsSold        Decimal  @default(0) @db.Decimal(14, 2)
  labCosts               Decimal  @default(0) @db.Decimal(14, 2)
  grossProfit            Decimal  @default(0) @db.Decimal(14, 2)
  personnelExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  rentExpenses           Decimal  @default(0) @db.Decimal(14, 2)
  adminExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  marketingExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  financialExpenses      Decimal  @default(0) @db.Decimal(14, 2)
  commissionExpenses     Decimal  @default(0) @db.Decimal(14, 2)
  otherExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  totalExpenses          Decimal  @default(0) @db.Decimal(14, 2)
  operatingProfit        Decimal  @default(0) @db.Decimal(14, 2)
  taxes                  Decimal  @default(0) @db.Decimal(14, 2)
  netProfit              Decimal  @default(0) @db.Decimal(14, 2)
  grossMarginPercent     Decimal? @db.Decimal(5, 2)
  operatingMarginPercent Decimal? @db.Decimal(5, 2)
  netMarginPercent       Decimal? @db.Decimal(5, 2)
  branch                 Branch?  @relation(fields: [branchId], references: [id])
  company                Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, branchId, periodYear, periodMonth])
  @@index([companyId, periodYear, periodMonth])
}

model AccountPayable {
  id              String               @id @default(cuid())
  companyId       String
  branchId        String?
  supplierId      String?
  description     String
  category        AccountCategory
  amount          Decimal              @db.Decimal(12, 2)
  dueDate         DateTime
  paidDate        DateTime?
  paidAmount      Decimal?             @db.Decimal(12, 2)
  status          AccountPayableStatus @default(PENDING)
  invoiceNumber   String?
  notes           String?
  createdByUserId String?
  paidByUserId    String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  branch          Branch?              @relation(fields: [branchId], references: [id])
  company         Company              @relation(fields: [companyId], references: [id])
  createdBy       User?                @relation("AccountPayableCreator", fields: [createdByUserId], references: [id])
  paidBy          User?                @relation("AccountPayablePayer", fields: [paidByUserId], references: [id])
  supplier        Supplier?            @relation(fields: [supplierId], references: [id])

  @@index([companyId, status, dueDate])
  @@index([supplierId, status])
  @@index([dueDate, status])
}

model AccountReceivable {
  id                String                  @id @default(cuid())
  companyId         String
  branchId          String?
  customerId        String?
  saleId            String?
  description       String
  installmentNumber Int                     @default(1)
  totalInstallments Int                     @default(1)
  amount            Decimal                 @db.Decimal(12, 2)
  dueDate           DateTime
  receivedDate      DateTime?
  receivedAmount    Decimal?                @db.Decimal(12, 2)
  status            AccountReceivableStatus @default(PENDING)
  notes             String?
  createdByUserId   String?
  receivedByUserId  String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  branch            Branch?                 @relation(fields: [branchId], references: [id])
  company           Company                 @relation(fields: [companyId], references: [id])
  createdBy         User?                   @relation("AccountReceivableCreator", fields: [createdByUserId], references: [id])
  customer          Customer?               @relation(fields: [customerId], references: [id])
  receivedBy        User?                   @relation("AccountReceivableReceiver", fields: [receivedByUserId], references: [id])
  sale              Sale?                   @relation(fields: [saleId], references: [id])

  @@index([companyId, status, dueDate])
  @@index([customerId, status])
  @@index([saleId])
  @@index([dueDate, status])
}

model StockAdjustment {
  id               String                @id @default(cuid())
  companyId        String
  productId        String
  type             StockAdjustmentType
  status           StockAdjustmentStatus @default(PENDING)
  quantityBefore   Int
  quantityChange   Int
  quantityAfter    Int
  unitCost         Decimal               @db.Decimal(12, 2)
  totalValue       Decimal               @db.Decimal(12, 2)
  reason           String
  attachments      String[]
  createdByUserId  String
  approvedByUserId String?
  approvedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  approvedBy       User?                 @relation("AdjustmentApprover", fields: [approvedByUserId], references: [id])
  company          Company               @relation(fields: [companyId], references: [id])
  createdBy        User                  @relation("AdjustmentCreator", fields: [createdByUserId], references: [id])
  product          Product               @relation(fields: [productId], references: [id])

  @@index([companyId, status, createdAt])
  @@index([productId, createdAt])
  @@index([createdByUserId])
  @@index([status, totalValue])
}

model SystemRule {
  id          String       @id @default(cuid())
  companyId   String
  category    RuleCategory
  key         String
  value       Json
  description String?
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  company     Company      @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
  @@index([companyId, category])
}

model ProductBarcode {
  id              String      @id @default(cuid())
  productId       String
  type            BarcodeType
  code            String
  isPrimary       Boolean     @default(false)
  createdByUserId String?
  createdAt       DateTime    @default(now())
  createdBy       User?       @relation("BarcodeCreator", fields: [createdByUserId], references: [id])
  product         Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, code])
  @@index([code])
  @@index([productId, isPrimary])
}

model Permission {
  id           String           @id @default(cuid())
  code         String           @unique
  name         String
  description  String?
  module       String
  category     String
  sortOrder    Int              @default(0)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  roleDefaults RolePermission[]
  userCustoms  UserPermission[]

  @@index([module])
  @@index([category])
  @@index([isActive])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         String
  permissionId String
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
}

model UserPermission {
  id              String     @id @default(cuid())
  userId          String
  permissionId    String
  granted         Boolean
  grantedByUserId String?
  grantedAt       DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  permission      Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user            User       @relation("UserCustomPermissions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model CompanySettings {
  id                    String   @id @default(cuid())
  companyId             String   @unique
  displayName           String?
  cnpj                  String?
  phone                 String?
  whatsapp              String?
  email                 String?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  logoUrl               String?
  messageThankYou       String?
  messageQuote          String?
  messageReminder       String?
  messageBirthday       String?
  pdfHeaderText         String?
  pdfFooterText         String?
  defaultQuoteValidDays Int      @default(15)
  defaultPaymentTerms   String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  primaryColor          String?
  company               Company  @relation("CompanySettings", fields: [companyId], references: [id])

  @@index([companyId])
}

model CashbackConfig {
  id                    String   @id @default(cuid())
  branchId              String   @unique
  enabled               Boolean  @default(false)
  earnPercent           Decimal  @default(3) @db.Decimal(5, 2)
  minPurchaseToEarn     Decimal  @default(100) @db.Decimal(10, 2)
  maxCashbackPerSale    Decimal? @db.Decimal(10, 2)
  expirationDays        Int      @default(90)
  minPurchaseMultiplier Decimal  @default(3) @db.Decimal(3, 1)
  maxUsagePercent       Decimal  @default(50) @db.Decimal(5, 2)
  birthdayMultiplier    Decimal  @default(2) @db.Decimal(3, 1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  branch                Branch   @relation(fields: [branchId], references: [id])
}

model CustomerCashback {
  id           String             @id @default(cuid())
  customerId   String
  branchId     String
  balance      Decimal            @default(0) @db.Decimal(10, 2)
  totalEarned  Decimal            @default(0) @db.Decimal(10, 2)
  totalUsed    Decimal            @default(0) @db.Decimal(10, 2)
  totalExpired Decimal            @default(0) @db.Decimal(10, 2)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  movements    CashbackMovement[]
  branch       Branch             @relation(fields: [branchId], references: [id])
  customer     Customer           @relation(fields: [customerId], references: [id])

  @@unique([customerId, branchId])
  @@index([customerId])
  @@index([branchId])
}

model CashbackMovement {
  id                 String               @id @default(cuid())
  customerCashbackId String
  type               CashbackMovementType
  amount             Decimal              @db.Decimal(10, 2)
  saleId             String?
  expiresAt          DateTime?
  expired            Boolean              @default(false)
  description        String?
  createdAt          DateTime             @default(now())
  createdByUserId    String?
  createdByUser      User?                @relation("CashbackMovementCreatedBy", fields: [createdByUserId], references: [id])
  customerCashback   CustomerCashback     @relation(fields: [customerCashbackId], references: [id])
  sale               Sale?                @relation(fields: [saleId], references: [id])

  @@index([customerCashbackId])
  @@index([saleId])
  @@index([expiresAt])
}

model ReminderConfig {
  id                              String   @id @default(cuid())
  branchId                        String   @unique
  prescriptionReminderEnabled     Boolean  @default(true)
  prescriptionReminderDays        Int      @default(30)
  prescriptionValidityMonths      Int      @default(12)
  inactiveReminderEnabled         Boolean  @default(true)
  inactiveAfterDays               Int      @default(180)
  birthdayReminderEnabled         Boolean  @default(true)
  birthdayReminderDaysBefore      Int      @default(0)
  cashbackExpiringReminderEnabled Boolean  @default(true)
  cashbackExpiringDaysBefore      Int      @default(7)
  enabledReminderTypes            String[]
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  branch                          Branch   @relation(fields: [branchId], references: [id])
}

model CustomerContact {
  id               String         @id @default(cuid())
  customerId       String
  branchId         String
  type             ContactType
  channel          ContactChannel @default(WHATSAPP)
  status           ContactStatus  @default(PENDING)
  reminderId       String?
  message          String?
  notes            String?
  executedByUserId String?
  executedAt       DateTime?
  createdAt        DateTime       @default(now())
  branch           Branch         @relation(fields: [branchId], references: [id])
  customer         Customer       @relation(fields: [customerId], references: [id])
  executedByUser   User?          @relation("ContactExecutedBy", fields: [executedByUserId], references: [id])
  reminder         Reminder?      @relation(fields: [reminderId], references: [id])

  @@index([customerId])
  @@index([branchId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Reminder {
  id                String            @id @default(cuid())
  branchId          String
  customerId        String
  type              ContactType
  status            ReminderStatus    @default(PENDING)
  scheduledFor      DateTime
  metadata          Json?
  dismissedAt       DateTime?
  dismissedByUserId String?
  dismissReason     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contacts          CustomerContact[]
  branch            Branch            @relation(fields: [branchId], references: [id])
  customer          Customer          @relation(fields: [customerId], references: [id])
  dismissedByUser   User?             @relation("ReminderDismissedBy", fields: [dismissedByUserId], references: [id])

  @@index([branchId])
  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([scheduledFor])
}

model SalesGoal {
  id          String       @id @default(cuid())
  branchId    String
  year        Int
  month       Int
  branchGoal  Decimal      @db.Decimal(12, 2)
  status      GoalStatus   @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  branch      Branch       @relation(fields: [branchId], references: [id])
  sellerGoals SellerGoal[]

  @@unique([branchId, year, month])
  @@index([branchId])
  @@index([year, month])
}

model SellerGoal {
  id          String    @id @default(cuid())
  salesGoalId String
  userId      String
  goalAmount  Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  salesGoal   SalesGoal @relation(fields: [salesGoalId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id])

  @@unique([salesGoalId, userId])
  @@index([userId])
}

model CommissionConfig {
  id                    String   @id @default(cuid())
  branchId              String   @unique
  baseCommissionPercent Decimal  @default(5) @db.Decimal(5, 2)
  goalBonusPercent      Decimal  @default(2) @db.Decimal(5, 2)
  categoryCommissions   Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  branch                Branch   @relation(fields: [branchId], references: [id])
}

model SellerCommission {
  id              String           @id @default(cuid())
  userId          String
  branchId        String
  year            Int
  month           Int
  totalSales      Decimal          @db.Decimal(12, 2)
  goalAmount      Decimal?         @db.Decimal(12, 2)
  goalAchieved    Boolean          @default(false)
  baseCommission  Decimal          @db.Decimal(10, 2)
  bonusCommission Decimal          @default(0) @db.Decimal(10, 2)
  totalCommission Decimal          @db.Decimal(10, 2)
  status          CommissionStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  branch          Branch           @relation(fields: [branchId], references: [id])
  user            User             @relation("SellerCommissions", fields: [userId], references: [id])

  @@unique([userId, branchId, year, month])
  @@index([userId])
  @@index([branchId])
  @@index([year, month])
}

enum UserRole {
  ADMIN
  GERENTE
  VENDEDOR
  CAIXA
  ATENDENTE
}

enum SaleStatus {
  OPEN
  COMPLETED
  CANCELED
  REFUNDED
}

enum PaymentMethod {
  CASH
  PIX
  DEBIT_CARD
  CREDIT_CARD
  BOLETO
  STORE_CREDIT
  CHEQUE
  AGREEMENT
  OTHER
}

enum PaymentStatus {
  PENDING
  RECEIVED
  VOIDED
  REFUNDED
}

enum CashShiftStatus {
  OPEN
  CLOSED
}

enum CashMovementType {
  SALE_PAYMENT
  REFUND
  SUPPLY
  WITHDRAWAL
  ADJUSTMENT
  OPENING_FLOAT
  CLOSING
}

enum CashDirection {
  IN
  OUT
}

enum ProductType {
  FRAME
  CONTACT_LENS
  ACCESSORY
  SUNGLASSES
  LENS_SERVICE
  SERVICE
  OPHTHALMIC_LENS
  OPTICAL_ACCESSORY
  LENS_SOLUTION
  CASE
  CLEANING_KIT
  OTHER
}

enum StockReservationStatus {
  RESERVED
  RELEASED
  CONSUMED
}

enum ServiceOrderStatus {
  DRAFT
  APPROVED
  SENT_TO_LAB
  IN_PROGRESS
  READY
  DELIVERED
  CANCELED
}

enum ServiceOrderPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum WarrantyStatus {
  ACTIVE
  IN_ANALYSIS
  APPROVED
  DENIED
  EXPIRED
  USED
}

enum WarrantyType {
  FRAME
  LENS
  MOUNTING
  ADJUSTMENT
}

enum FiscalStatus {
  NOT_REQUESTED
  PENDING
  AUTHORIZED
  FAILED
  CANCELED
}

enum QuoteStatus {
  OPEN
  SENT
  APPROVED
  CONVERTED
  EXPIRED
  CANCELED
  PENDING
  CANCELLED
}

enum QuoteItemType {
  PRODUCT
  SERVICE
  CUSTOM
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELED
}

enum AppointmentType {
  PICKUP
  ADJUSTMENT
  CONSULTATION
  RETURN
  EXAM
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELED
}

enum AgreementType {
  HEALTH_PLAN
  CORPORATE
  UNION
  ASSOCIATION
  PARTNERSHIP
}

enum StockMovementType {
  PURCHASE
  CUSTOMER_RETURN
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
  SALE
  LOSS
  SUPPLIER_RETURN
  INTERNAL_USE
  OTHER
}

enum CashbackMovementType {
  CREDIT
  DEBIT
  EXPIRED
  ADJUSTMENT
  BONUS
}

enum ContactType {
  PRESCRIPTION_REMINDER
  BIRTHDAY_GREETING
  INACTIVE_REACTIVATION
  CASHBACK_EXPIRING
  CASHBACK_AVAILABLE
  SALE_THANK_YOU
  ORDER_READY
  CUSTOM
}

enum ContactChannel {
  WHATSAPP
  PHONE
  EMAIL
  SMS
}

enum ContactStatus {
  PENDING
  SENT
  CONFIRMED
  SKIPPED
  FAILED
}

enum ReminderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DISMISSED
  EXPIRED
}

enum GoalStatus {
  ACTIVE
  CLOSED
  CANCELLED
}

enum LensType {
  SINGLE_VISION
  BIFOCAL
  MULTIFOCAL
  OCCUPATIONAL
}

enum AccountPayableStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

enum AccountReceivableStatus {
  PENDING
  RECEIVED
  OVERDUE
  CANCELED
}

enum AccountCategory {
  SUPPLIERS
  RENT
  UTILITIES
  PERSONNEL
  TAXES
  MARKETING
  MAINTENANCE
  EQUIPMENT
  OTHER
}

enum StockAdjustmentType {
  DAMAGE
  THEFT
  SUPPLIER_RETURN
  COUNT_ERROR
  FREE_SAMPLE
  EXPIRATION
  INTERNAL_USE
  OTHER
}

enum StockAdjustmentStatus {
  PENDING
  APPROVED
  REJECTED
  AUTO_APPROVED
}

enum RuleCategory {
  STOCK
  SALES
  FINANCIAL
  PRODUCTS
  CUSTOMERS
  REPORTS
}

enum BarcodeType {
  EAN13
  CODE128
  QRCODE
}
